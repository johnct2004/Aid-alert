{% extends 'seller/base_seller.html' %}
{% load static %}

{% block page_title %}Manage Delivery{% endblock %}
{% block content_title %}Manage Delivery{% endblock %}

{% block seller_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="{% static 'css/seller/manage_delivery.css' %}">
{% endblock %}

{% block seller_content %}
<!-- Delivery Stats -->
<div class="stats-grid">
    <div class="glass-card stat-card">
        <div class="stat-icon icon-blue">
            <span class="material-icons-round">local_shipping</span>
        </div>
        <div class="stat-content">
            <h3 class="stat-value">{{ total_deliveries }}</h3>
            <p class="stat-label">Total Deliveries</p>
        </div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-icon icon-orange">
            <span class="material-icons-round">pending_actions</span>
        </div>
        <div class="stat-content">
            <h3 class="stat-value">{{ pending_shipments }}</h3>
            <p class="stat-label">Pending Shipments</p>
        </div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-icon icon-purple">
            <span class="material-icons-round">inventory</span>
        </div>
        <div class="stat-content">
            <h3 class="stat-value">{{ in_transit }}</h3>
            <p class="stat-label">In Transit</p>
        </div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-icon icon-green">
            <span class="material-icons-round">today</span>
        </div>
        <div class="stat-content">
            <h3 class="stat-value">{{ delivered_today }}</h3>
            <p class="stat-label">Delivered Today</p>
        </div>
    </div>
</div>

<div class="dashboard-sections">
    <!-- Delivery Management -->
    <section class="glass-card content-card">
        <div class="card-header-row">
            <h2 class="card-title">Delivery Management</h2>
            <div class="delivery-actions" data-schedule-url="{% url 'aid_app:schedule_pickup' %}"
                data-bulk-ship-url="{% url 'aid_app:bulk_ship' %}">
                <button class="btn-secondary schedule-btn">
                    <span class="material-icons-round">schedule</span>
                    Schedule Pickup
                </button>
                <button class="btn-action bulk-ship-btn">
                    <span class="material-icons-round">playlist_add_check</span>
                    Bulk Ship
                </button>
            </div>
        </div>

        <div class="filters-wrapper">
            <div class="search-box">
                <span class="material-icons-round search-icon">search</span>
                <input type="text" id="deliverySearch" class="search-input"
                    placeholder="Search by order ID, customer, or tracking number...">
            </div>

            <div class="filter-controls">
                <select id="statusFilter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="picked-up">Picked Up</option>
                    <option value="in-transit">In Transit</option>
                    <option value="out-for-delivery">Out for Delivery</option>
                    <option value="delivered">Delivered</option>
                    <option value="failed">Failed</option>
                </select>

                <select id="carrierFilter" class="filter-select">
                    <option value="">All Carriers</option>
                    <option value="fedex">FedEx</option>
                    <option value="ups">UPS</option>
                    <option value="dhl">DHL</option>
                    <option value="usps">USPS</option>
                    <option value="local">Local Delivery</option>
                </select>

                <select id="priorityFilter" class="filter-select">
                    <option value="">All Priority</option>
                    <option value="standard">Standard</option>
                    <option value="express">Express</option>
                    <option value="overnight">Overnight</option>
                    <option value="same-day">Same Day</option>
                </select>
            </div>
        </div>

        <div class="deliveries-table-container">
            <div class="deliveries-table">
                <div class="table-header">
                    <div class="header-cell">Order ID</div>
                    <div class="header-cell">Customer</div>
                    <div class="header-cell">Carrier</div>
                    <div class="header-cell">Tracking</div>
                    <div class="header-cell">Priority</div>
                    <div class="header-cell">Status</div>
                    <div class="header-cell">Actions</div>
                </div>

                <div class="table-body">
                    {% for delivery in deliveries %}
                    <div class="table-row">
                        <div class="table-cell order-id-cell">
                            <span class="order-id">#{{ delivery.order_id }}</span>
                        </div>
                        <div class="table-cell customer-cell">
                            <div class="customer-info">
                                <h4 class="customer-name">{{ delivery.customer.username }}</h4>

                            </div>
                        </div>
                        <div class="table-cell carrier-cell">
                            <span class="carrier-badge {{ delivery.carrier|lower|default:'local' }}">{{ delivery.carrier }}</span>
                        </div>
                        <div class="table-cell tracking-cell">
                            <span class="tracking-number">{{ delivery.tracking_number|default:'-' }}</span>
                        </div>
                        <div class="table-cell priority-cell">
                            {{ delivery.priority }}
                        </div>
                        <div class="table-cell status-cell">
                            {{ delivery.get_status_display }}
                            {% if delivery.current_location %}
                            <br><small class="text-muted">{{ delivery.current_location }}</small>
                            {% endif %}
                        </div>
                        <div class="table-cell actions-cell">
                            <button class="action-btn track-btn" title="Update Location" data-id="{{ delivery.id }}"
                                data-status="{{ delivery.status }}" data-location="{{ delivery.current_location }}"
                                data-lat="{{ delivery.latitude|default:0 }}"
                                data-lng="{{ delivery.longitude|default:0 }}">
                                <span class="material-icons-round">edit_location</span>
                            </button>
                            {% if delivery.status == 'pending' %}
                            <button class="action-btn ship-btn" title="Ship">
                                <span class="material-icons-round">local_shipping</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="no-deliveries">
                        <div class="no-deliveries-icon">
                            <span class="material-icons-round">local_shipping</span>
                        </div>
                        <h3>No deliveries found</h3>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Update Location Modal -->
        <div id="updateLocationModal" class="glass-card"
            style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:2000; padding:20px; width:400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <h3>Update Delivery Status</h3>
            <form id="updateLocationForm" onsubmit="submitUpdate(event)">
                <input type="hidden" id="updateOrderId">

                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:5px;">Status</label>
                    <select id="updateStatus" class="search-input">
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">In Transit (Shipped)</option>
                        <option value="delivered">Delivered</option>
                    </select>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:5px;">Current Location</label>
                    <input type="text" id="updateLocation" class="search-input"
                        placeholder="e.g. Warehouse A, Springfield">
                </div>

                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <div style="flex:1">
                        <label style="display:block; margin-bottom:5px;">Latitude</label>
                        <input type="number" step="any" id="updateLat" class="search-input" placeholder="0.00">
                    </div>
                    <div style="flex:1">
                        <label style="display:block; margin-bottom:5px;">Longitude</label>
                        <input type="number" step="any" id="updateLng" class="search-input" placeholder="0.00">
                    </div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('updateLocationModal').style.display='none'">Cancel</button>
                    <button type="submit" class="bulk-ship-btn"
                        style="border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">Update</button>
                </div>
            </form>
        </div>

        <div class="pagination">
            <button class="pagination-btn prev-btn">
                <span class="material-icons-round">chevron_left</span>
            </button>
            <div class="pagination-numbers">
                <!-- Injected by JS -->
            </div>
            <button class="pagination-btn next-btn">
                <span class="material-icons-round">chevron_right</span>
            </button>
        </div>
    </section>

    <!-- Delivery Map -->
    <section class="glass-card content-card">
        <div class="card-header-row">
            <h2 class="card-title">Live Delivery Tracking</h2>
            <div class="map-actions">
                <button class="btn-secondary refresh-btn">
                    <span class="material-icons-round">refresh</span>
                    Refresh
                </button>
            </div>
        </div>

        <div class="delivery-map-container">
            <div class="delivery-map" id="deliveryMap">
                <div id="mapContainer"></div>
                <div class="map-overlay">
                    <div class="tracking-info glass-card">
                        <div class="tracking-header">
                            <span class="material-icons-round">location_on</span>
                            <h3>Live Tracking</h3>
                        </div>
                        <div class="tracking-stats">
                            <div class="stat-item">
                                <span class="stat-label">Active</span>
                                <span class="stat-value" id="activeDeliveries">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">In Transit</span>
                                <span class="stat-value" id="inTransitCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Delivered</span>
                                <span class="stat-value" id="deliveredToday">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block seller_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="{% static 'js/seller/manage_delivery.js' %}"></script>
{% endblock %}