{% extends 'user/base_user.html' %}
{% load static %}

{% block page_title %}Book a Responder{% endblock %}

{% block user_css %}
<link rel="stylesheet" href="{% static 'css/user/book_responder_new.css' %}">
{% endblock %}

{% block user_content %}
<div class="booking-container">
    <!-- Booking Form Section -->
    <section class="glass-card booking-form-section">
        <div class="section-header">
            <h2>Request Emergency Responder</h2>
            <p>Fill in the details below to book an emergency responder for immediate assistance</p>
        </div>

        <form class="booking-form" id="bookingForm" method="post">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label for="emergencyType">
                        <span class="material-icons-round">emergency</span>
                        Emergency Type
                    </label>
                    <select id="emergencyType" name="emergencyType" class="glass-input" required>
                        <option value="">Select Emergency Type</option>
                        <option value="medical">Medical Emergency</option>
                        <option value="accident">Accident/Injury</option>
                        <option value="fire">Fire Emergency</option>
                        <option value="crime">Crime/Safety Threat</option>
                        <option value="natural">Natural Disaster</option>
                        <option value="other">Other Emergency</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="urgencyLevel">
                        <span class="material-icons-round">priority_high</span>
                        Urgency Level
                    </label>
                    <select id="urgencyLevel" name="urgencyLevel" class="glass-input" required>
                        <option value="">Select Urgency</option>
                        <option value="critical">Critical - Life Threatening</option>
                        <option value="urgent">Urgent - Immediate Attention</option>
                        <option value="moderate">Moderate - Within Hour</option>
                        <option value="low">Low - Scheduled Response</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label for="location">
                        <span class="material-icons-round">location_on</span>
                        Location Address
                    </label>
                    <input type="text" id="location" name="location" class="glass-input"
                        placeholder="Enter complete address or landmark" required>
                </div>

                <div class="form-group">
                    <label for="contactNumber">
                        <span class="material-icons-round">phone</span>
                        Contact Number
                    </label>
                    <input type="tel" id="contactNumber" name="contactNumber" class="glass-input"
                        placeholder="Enter 10-digit phone number" maxlength="10" pattern="[0-9]{10}" required>
                    <small class="form-hint">Enter exactly 10 digits (e.g., 9876543210)</small>
                </div>

                <div class="form-group">
                    <label for="victimsCount">
                        <span class="material-icons-round">people</span>
                        Number of Victims
                    </label>
                    <input type="number" id="victimsCount" name="victimsCount" class="glass-input" min="1"
                        placeholder="How many people need help?" required>
                </div>

                <div class="form-group full-width">
                    <label for="description">
                        <span class="material-icons-round">description</span>
                        Emergency Description
                    </label>
                    <textarea id="description" name="description" class="glass-input" rows="4"
                        placeholder="Describe the emergency situation in detail..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="specialInstructions">
                        <span class="material-icons-round">info</span>
                        Special Instructions
                    </label>
                    <textarea id="specialInstructions" name="specialInstructions" class="glass-input" rows="2"
                        placeholder="Any special instructions for responders (e.g., gate codes, building access)"></textarea>
                </div>

                <div class="form-group full-width">
                    <label class="checkbox-label">
                        <input type="checkbox" id="consent" name="consent" required
                            style="width: auto; margin-right: 10px;">
                        I consent to emergency services and understand this is for genuine emergency situations only
                    </label>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" style="width: auto; padding: 10px 24px;">
                    <span class="material-icons-round">clear</span>
                    Clear Form
                </button>
                <button type="submit" class="btn btn-primary"
                    style="width: auto; padding: 10px 24px; min-width: 150px;">
                    <span class="material-icons-round">send</span>
                    Book Responder
                </button>
            </div>
        </form>
    </section>

    <!-- Available Responders Section -->
    <section class="glass-card responders-section">
        <div class="section-header">
            <h2>Available Responders</h2>
            <p>Nearby emergency responders ready to assist</p>
        </div>

        <div class="responders-grid" id="respondersGrid">
            {% for responder in responders %}
            <div class="responder-card available">
                <div class="responder-header">
                    <div class="responder-info">
                        <div class="responder-avatar">
                            <span class="material-icons-round">local_hospital</span>
                        </div>
                        <div class="responder-details">
                            <h3>{{ responder.user.get_full_name|default:responder.user.username }}</h3>
                            <p class="responder-type">{{ responder.specialization|default:"General Emergency" }}</p>
                            <div class="responder-rating">
                                <span class="material-icons-round">star</span>
                                <span>4.9</span>
                                <span class="rating-count">(12)</span>
                            </div>
                        </div>
                    </div>
                    <div class="responder-status badge-{{ responder.status }}">
                        <span class="status-dot"></span>
                        <span>{{ responder.get_status_display }}</span>
                    </div>
                </div>

                <div class="responder-stats">
                    <div class="stat">
                        <span class="material-icons-round">schedule</span>
                        <span>5-10 min</span>
                    </div>
                    <div class="stat">
                        <span class="material-icons-round">location_on</span>
                        <span>Unknown</span>
                    </div>
                    <div class="stat">
                        <span class="material-icons-round">verified</span>
                        <span>Certified</span>
                    </div>
                </div>

                <div class="responder-skills">
                    <span class="skill-tag">First Aid</span>
                    <span class="skill-tag">CPR</span>
                </div>

                <div class="responder-actions">
                    <button class="btn btn-sm btn-secondary" style="width: auto; padding: 6px 16px; font-size: 0.85rem;"
                        onclick="openProfileModal('{{ responder.user.get_full_name|default:responder.user.username|escapejs }}', 'Responder', '{{ responder.get_status_display|escapejs }}', '{{ responder.responder_id|escapejs }}', '{{ responder.specialization|escapejs }}')">
                        View Profile
                    </button>
                    <button class="btn btn-sm btn-primary" style="width: auto; padding: 6px 16px; font-size: 0.85rem;"
                        onclick="bookResponder('{{ responder.user.get_full_name|default:responder.user.username|escapejs }}', '{{ responder.responder_id|escapejs }}')">
                        Book Now
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="no-responders" style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                <span class="material-icons-round"
                    style="font-size: 48px; color: #ddd; margin-bottom: 10px;">person_off</span>
                <p>No responders are currently available nearby.</p>
                <p>Please submit a general emergency request above.</p>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Recent Bookings Section -->
    <section class="glass-card recent-bookings-section">
        <div class="section-header">
            <h2>Your Recent Bookings</h2>
            <p>History of your recent responder bookings</p>
        </div>

        <div class="bookings-list">
            {% for booking in recent_bookings %}
            <div class="booking-item completed">
                <div class="booking-status badge-{{ booking.status }}">
                    <span class="material-icons-round">
                        {% if booking.status == 'open' %}pending
                        {% elif booking.status == 'assigned' %}check_circle
                        {% elif booking.status == 'completed' %}done_all
                        {% else %}info{% endif %}
                    </span>
                    <span>{{ booking.get_status_display }}</span>
                </div>
                <div class="booking-details">
                    <h4>{{ booking.get_incident_type_display }} - {{ booking.get_severity_display }}</h4>
                    <p>ID: {{ booking.incident_id }} • {{ booking.created_at|date:"M d, Y • h:i A" }}</p>
                </div>
                <div class="booking-actions">
                    <button class="btn btn-sm btn-secondary"
                        onclick="alert('Incident ID: {{ booking.incident_id }}\nDescription: {{ booking.description|escapejs }}\nLocation: {{ booking.location|escapejs }}')">View
                        Details</button>
                    <a href="{% url 'aid_app:give_feedback' %}" class="btn btn-sm btn-secondary"
                        style="text-decoration: none;">Rate Service</a>
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; color: #666; padding: 20px;">
                <p>No recent bookings found.</p>
            </div>
            {% endfor %}
        </div>
    </section>
</div>
<!-- Profile Modal -->
<div id="profileModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px);">
    <div class="modal-content glass-card"
        style="background: rgba(255, 255, 255, 0.95); margin: 15% auto; padding: 0; border: 1px solid #ddd; width: 90%; max-width: 500px; border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);">
        <div class="modal-header"
            style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 1.5rem; color: #333;">Responder Profile</h2>
            <span class="close" onclick="closeModal()"
                style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                <div
                    style="width: 80px; height: 80px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                    <span class="material-icons-round" style="font-size: 40px;">person</span>
                </div>
                <div>
                    <h3 id="modalName" style="margin: 0 0 5px 0; font-size: 1.3rem;"></h3>
                    <p id="modalRole" style="margin: 0; color: #666;"></p>
                    <div style="display: flex; align-items: center; margin-top: 5px; color: #f1c40f;">
                        <span class="material-icons-round" style="font-size: 18px;">star</span>
                        <span style="margin-left: 5px; font-weight: bold;">4.9</span>
                    </div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    <span style="display: block; font-size: 0.8rem; color: #888;">Status</span>
                    <span id="modalStatus" style="font-weight: 600; color: #2ecc71;">Available</span>
                </div>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    <span style="display: block; font-size: 0.8rem; color: #888;">ID</span>
                    <span id="modalId" style="font-weight: 600; color: #333;"></span>
                </div>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    <span style="display: block; font-size: 0.8rem; color: #888;">Specialization</span>
                    <span id="modalSpec" style="font-weight: 600; color: #333;"></span>
                </div>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    <span style="display: block; font-size: 0.8rem; color: #888;">Certifications</span>
                    <span style="font-weight: 600; color: #333;">Certified Responder</span>
                </div>
            </div>
            <button onclick="bookFromModal()" class="btn btn-primary" style="width: 100%; justify-content: center;">Book
                Now</button>
        </div>
    </div>
</div>
{% endblock %}

{% block user_js %}
<script src="{% static 'js/user/book_responder.js' %}"></script>
{% endblock %}