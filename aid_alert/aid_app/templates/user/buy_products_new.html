{% extends 'user/base_user.html' %}
{% load static %}

{% block page_title %}Emergency Products{% endblock %}

{% block user_css %}
<link rel="stylesheet" href="{% static 'css/user/buy_products_new.css' %}">
{% endblock %}

{% block user_content %}
<div class="products-container">
    <!-- Categories -->
    <div class="glass-card categories-wrapper">
        <div class="categories">
            <button class="category-btn active" onclick="filterCategory('all')">
                <span class="material-icons-round">grid_view</span>
                All
            </button>
            <button class="category-btn" onclick="filterCategory('first-aid')">
                <span class="material-icons-round">medical_services</span>
                First Aid
            </button>
            <button class="category-btn" onclick="filterCategory('emergency')">
                <span class="material-icons-round">emergency</span>
                Emergency
            </button>
            <button class="category-btn" onclick="filterCategory('safety')">
                <span class="material-icons-round">health_and_safety</span>
                Safety
            </button>
            <button class="category-btn" onclick="filterCategory('medical')">
                <span class="material-icons-round">healing</span>
                Medical
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content-area">
        <!-- Products Grid -->
        <div class="products-grid" id="productsGrid">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Floating Cart Summary -->
    <div class="cart-summary-floating">
        <div class="cart-summary-content" onclick="openCart()">
            <div class="cart-icon-wrapper">
                <span class="material-icons-round">shopping_cart</span>
                <span class="cart-badge-count">0</span>
            </div>
            <div class="cart-text-details">
                <span class="cart-total-label">Total</span>
                <span class="cart-total-value">$0.00</span>
            </div>
        </div>
    </div>
</div>

<!-- Shopping Cart Modal -->
<div class="modal-backdrop" id="cartModal">
    <div class="glass-card modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Shopping Cart</h2>
            <button class="modal-close" onclick="closeCart()">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="cart-items" id="cartItems">
                <!-- Cart items will be populated by JavaScript -->
            </div>
            <div class="cart-summary-modal">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="cartSubtotal">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tax (10%):</span>
                    <span id="cartTax">$0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="cartTotal">$0.00</span>
                </div>
            </div>
            <div class="cart-actions">
                <button class="btn btn-secondary" onclick="clearCart()">Clear Cart</button>
                <button class="btn btn-primary" onclick="checkout()">Proceed to Checkout</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block user_js %}
<script>
    // Sample products data (mirrored from original)
    const products = [
        {% for product in products %}
    {
        id: '{{ product.id }}',
            name: '{{ product.name|escapejs }}',
                category: '{{ product.category }}', // Matches model choices
                    price: { { product.price } },
        image: '{% if product.image %}{{ product.image.url }}{% else %}https://via.placeholder.com/200x150?text=No+Image{% endif %}',
            description: '{{ product.description|escapejs|linebreaksbr }}',
                inStock: { { product.stock_quantity } } > 0,
                    stock: { { product.stock_quantity } },
        rating: 4.5, // Placeholder
            reviews: 12  // Placeholder
    },
    {% endfor %}
    ];

    let cart = [];
    let currentCategory = 'all';

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function () {
        renderProducts();
        updateCartSummary();
    });

    function renderProducts(category = 'all') {
        const grid = document.getElementById('productsGrid');
        const filteredProducts = category === 'all'
            ? products
            : products.filter(p => p.category === category);

        grid.innerHTML = '';

        if (filteredProducts.length === 0) {
            grid.innerHTML = `
                <div class="no-products glass-card">
                    <div class="no-products-icon">
                        <span class="material-icons-round">shopping_bag</span>
                    </div>
                    <h3>No Products Available</h3>
                    <p>No products have been added by sellers or facility managers yet.</p>
                </div>
            `;
            return;
        }

        filteredProducts.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'glass-card product-card';

            const stockStatus = product.inStock
                ? '<span class="status-badge in-stock">In Stock</span>'
                : '<span class="status-badge out-of-stock">Out of Stock</span>';

            const buttonText = product.inStock ? 'Add to Cart' : 'Out of Stock';
            const buttonDisabled = product.inStock ? '' : 'disabled';

            productCard.innerHTML = `
                <div class="product-image">
                    <img src="${product.image}" alt="${product.name}">
                    ${stockStatus}
                </div>
                <div class="product-info">
                    <h3>${product.name}</h3>
                    <p class="product-description">${product.description}</p>
                    <div class="product-meta">
                        <div class="rating">
                            <span class="material-icons-round">star</span>
                            <span>${product.rating}</span>
                            <span class="reviews">(${product.reviews})</span>
                        </div>
                        <div class="price">$${product.price}</div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-primary" onclick="addToCart('${product.id}')" ${buttonDisabled}>
                            <span class="material-icons-round">add_shopping_cart</span>
                            ${buttonText}
                        </button>
                        <button class="btn btn-secondary" onclick="buyNow('${product.id}')" ${buttonDisabled}>
                            <span class="material-icons-round">bolt</span>
                            Buy Now
                        </button>
                    </div>
                </div>
            `;
            grid.appendChild(productCard);
        });
    }

    function filterCategory(category) {
        currentCategory = category;

        // Update active button
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.category-btn').classList.add('active');

        renderProducts(category);
    }

    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (!product || !product.inStock) return;

        const existingItem = cart.find(item => item.id === productId);

        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({
                ...product,
                quantity: 1
            });
        }

        updateCartSummary();
        showNotification(`${product.name} added to cart!`);
    }

    function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        updateCartSummary();
        renderCart();
    }

    function buyNow(productId) {
        const product = products.find(p => p.id === productId);
        if (!product || !product.inStock) return;

        // Add single item to cart and go to checkout
        cart = [{
            ...product,
            quantity: 1
        }];

        showNotification('Redirecting to checkout...');

        // Store cart data in sessionStorage for checkout page
        sessionStorage.setItem('checkoutCart', JSON.stringify(cart));

        // Redirect to existing checkout page
        window.location.href = '{% url "aid_app:checkout" %}';
    }

    function updateQuantity(productId, change) {
        const item = cart.find(item => item.id === productId);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                updateCartSummary();
                renderCart();
            }
        }
    }

    function updateCartSummary() {
        const itemCount = cart.reduce((total, item) => total + item.quantity, 0);
        const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        const tax = subtotal * 0.1;
        const total = subtotal + tax;

        // Floating cart update
        document.querySelector('.cart-badge-count').textContent = itemCount;
        document.querySelector('.cart-total-value').textContent = `$${total.toFixed(2)}`;

        // Update modal summary
        document.getElementById('cartSubtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('cartTax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
    }

    function openCart() {
        document.getElementById('cartModal').style.display = 'flex';
        renderCart();
    }

    function closeCart() {
        document.getElementById('cartModal').style.display = 'none';
    }

    function renderCart() {
        const cartItems = document.getElementById('cartItems');

        if (cart.length === 0) {
            cartItems.innerHTML = '<div class="empty-cart"><span class="material-icons-round">shopping_cart</span><p>Your cart is empty</p></div>';
            return;
        }

        cartItems.innerHTML = cart.map(item => `
            <div class="cart-item">
                <div class="cart-item-image">
                    <img src="${item.image}" alt="${item.name}">
                </div>
                <div class="cart-item-details">
                    <h4>${item.name}</h4>
                    <p>$${item.price.toFixed(2)}</p>
                </div>
                <div class="cart-item-quantity">
                    <button class="quantity-btn" onclick="updateQuantity('${item.id}', -1)">-</button>
                    <span>${item.quantity}</span>
                    <button class="quantity-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                </div>
                <button class="remove-btn" onclick="removeFromCart('${item.id}')">
                    <span class="material-icons-round">delete</span>
                </button>
            </div>
        `).join('');
    }

    function clearCart() {
        if (confirm('Are you sure you want to clear your cart?')) {
            cart = [];
            updateCartSummary();
            renderCart();
            showNotification('Cart cleared');
        }
    }

    function checkout() {
        if (cart.length === 0) {
            showNotification('Your cart is empty!');
            return;
        }

        // Store cart data in sessionStorage for checkout page
        sessionStorage.setItem('checkoutCart', JSON.stringify(cart));

        // Redirect to checkout page
        window.location.href = '{% url "aid_app:checkout" %}';
    }

    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'glass-card notification';
        notification.textContent = message;
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.background = 'var(--primary-color)';
        notification.style.color = 'white';
        notification.style.padding = '15px 25px';
        notification.style.borderRadius = '10px';
        notification.style.zIndex = '10000';
        notification.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('cartModal');
        if (event.target === modal) {
            closeCart();
        }
    }
</script>
{% endblock %}