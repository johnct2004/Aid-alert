{% extends 'user/base_user.html' %}
{% load static %}

{% block page_title %}Checkout{% endblock %}

{% block header_profile %}{% endblock %}

{% block user_css %}
<link rel="stylesheet" href="{% static 'css/user/user_dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/user/check_out.css' %}">
{% endblock %}

{% block user_content %}
<div class="content-wrapper">
    <div class="checkout-container">
        <!-- Checkout Form -->
        <div class="checkout-form">
            <form id="checkoutForm">
                <!-- Shipping Information -->
                <section class="form-section">
                    <h2 class="section-title">
                        <span class="material-icons-round">location_on</span>
                        Shipping Information
                    </h2>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="firstName">First Name</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>

                        <div class="form-group">
                            <label for="lastName">Last Name</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>

                    <div class="form-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address" name="address" required>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" required>
                        </div>

                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" name="state" placeholder="Enter your state" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" id="country" name="country" placeholder="Enter your country" required>
                    </div>

                    <div class="form-group">
                        <label for="zipCode">ZIP Code</label>
                        <input type="text" id="zipCode" name="zipCode" required>
                    </div>
                </section>

                <!-- Payment Information -->
                <section class="form-section">
                    <h2 class="section-title">
                        <span class="material-icons-round">payment</span>
                        Payment Information
                    </h2>

                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="card" checked>
                            <span class="payment-label">
                                <span class="material-icons-round">credit_card</span>
                                Credit/Debit Card
                            </span>
                        </label>

                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="paypal">
                            <span class="payment-label">
                                <span class="material-icons-round">account_balance_wallet</span>
                                PayPal
                            </span>
                        </label>

                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="cod" id="codOption">
                            <span class="payment-label">
                                <span class="material-icons-round">payments</span>
                                Cash on Delivery
                            </span>
                        </label>
                    </div>

                    <div id="cardPayment" class="payment-details">
                        <div class="form-group">
                            <label for="cardNumber">Card Number</label>
                            <input type="text" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456"
                                required>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="expiry">Expiry Date</label>
                                <input type="text" id="expiry" name="expiry" placeholder="MM/YY" required>
                            </div>

                            <div class="form-group">
                                <label for="cvv">CVV</label>
                                <input type="text" id="cvv" name="cvv" placeholder="123" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="cardName">Name on Card</label>
                            <input type="text" id="cardName" name="cardName" required>
                        </div>
                    </div>
                </section>

                <!-- Order Notes -->
                <section class="form-section">
                    <h2 class="section-title">
                        <span class="material-icons-round">note</span>
                        Order Notes (Optional)
                    </h2>

                    <div class="form-group">
                        <label for="orderNotes">Special Instructions</label>
                        <textarea id="orderNotes" name="orderNotes" rows="3"
                            placeholder="Any special delivery instructions or notes..."></textarea>
                    </div>
                </section>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="goBack()">
                        <span class="material-icons-round">arrow_back</span>
                        Back to Cart
                    </button>
                    <button type="submit" class="btn-primary">
                        <span class="material-icons-round">lock</span>
                        Place Order
                    </button>
                </div>
            </form>
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
            <div class="summary-card">
                <h2 class="summary-title">
                    <span class="material-icons-round">shopping_cart</span>
                    Order Summary
                </h2>

                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be populated by JavaScript -->
                </div>

                <div class="summary-details">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping:</span>
                        <span id="shipping">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (10%):</span>
                        <span id="tax">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                </div>

                <div class="promo-section">
                    <div class="form-group">
                        <label for="promoCode">Promo Code</label>
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Enter promo code">
                            <button type="button" class="btn-secondary" onclick="applyPromo()">Apply</button>
                        </div>
                    </div>
                </div>

                <div class="security-info">
                    <div class="security-item">
                        <span class="material-icons-round">verified_user</span>
                        <span>Secure Payment</span>
                    </div>
                    <div class="security-item">
                        <span class="material-icons-round">lock</span>
                        <span>SSL Encrypted</span>
                    </div>
                    <div class="security-item">
                        <span class="material-icons-round">local_shipping</span>
                        <span>Fast Delivery</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block user_js %}
<script>
    // Load cart from sessionStorage
    const cartItems = JSON.parse(sessionStorage.getItem('checkoutCart')) || [];

    let shippingCost = 9.99;
    let taxRate = 0.1;
    let discount = 0;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function () {
        if (cartItems.length === 0) {
            // Redirect back if empty
            window.location.href = '{% url "aid_app:buy_products" %}';
            return;
        }
        renderCartItems();
        updateOrderSummary();
        setupEventListeners();
    });

    function setupEventListeners() {
        // Form submission
        document.getElementById('checkoutForm').addEventListener('submit', handleCheckout);

        // ... (rest of listeners same as before) ...
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', togglePaymentMethod);
        });

        // ... (card inputs listeners) ... 
    }

    // ... (renderCartItems, updateOrderSummary, togglePaymentMethod, applyPromo, showNotification functions same as before) ...

    function renderCartItems() {
        const cartContainer = document.getElementById('cartItems');

        cartContainer.innerHTML = cartItems.map(item => `
                <div class="cart-item">
                    <div class="item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="item-details">
                        <h4>${item.name}</h4>
                        <p>Qty: ${item.quantity}</p>
                    </div>
                    <div class="item-price">
                        $${(item.price * item.quantity).toFixed(2)}
                    </div>
                </div>
            `).join('');
    }

    function updateOrderSummary() {
        const subtotal = cartItems.reduce((total, item) => total + (item.price * item.quantity), 0);
        const tax = subtotal * taxRate;
        const total = subtotal + shippingCost + tax - discount;

        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('shipping').textContent = `$${shippingCost.toFixed(2)}`;
        document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('total').textContent = `$${total.toFixed(2)}`;
    }

    function togglePaymentMethod() {
        // ... (Logic from before) ...
        const method = document.querySelector('input[name="paymentMethod"]:checked').value;
        const cardPayment = document.getElementById('cardPayment');

        if (method === 'card') {
            cardPayment.style.display = 'block';
            document.querySelectorAll('#cardPayment input').forEach(i => i.required = true);
        } else {
            cardPayment.style.display = 'none';
            document.querySelectorAll('#cardPayment input').forEach(i => i.required = false);
        }
    }

    function applyPromo() {
        // ... (Logic from before) ...
        const promoCode = document.getElementById('promoCode').value.toUpperCase();
        if (promoCode === 'SAVE10') { discount = 10; showNotification('Applied!'); }
        updateOrderSummary();
    }

    async function handleCheckout(event) {
        event.preventDefault();

        // Basic validation
        const form = document.getElementById('checkoutForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        showNotification('Processing your order...');

        // Prepare data for backend
        const checkoutData = {
            cart: cartItems.map(item => ({
                id: item.id,
                quantity: item.quantity
            })),
            shipping: {
                firstName: document.getElementById('firstName').value,
                // ... other fields ...
            }
        };

        try {
            const response = await fetch('{% url "aid_app:process_checkout" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(checkoutData)
            });

            const result = await response.json();

            if (result.success) {
                showNotification('Order placed successfully!');
                // Clear cart
                sessionStorage.removeItem('checkoutCart');
                // Redirect
                setTimeout(() => {
                    window.location.href = '{% url "aid_app:processing" %}';
                }, 1500);
            } else {
                showNotification(result.message || 'Order failed');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('An error occurred. Please try again.');
        }
    }

    function showNotification(message) {
        // ... (same as before) ...
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }
</script>
{% endblock %}