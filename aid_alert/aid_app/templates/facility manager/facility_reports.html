{% extends 'facility manager/base_facility.html' %}
{% load static %}

{% block page_title %}Facility Reports{% endblock %}
{% block content_title %}Facility Reports{% endblock %}

{% block facility_css %}
<link rel="stylesheet" href="{% static 'css/facility manager/facility_reports.css' %}">
{% endblock %}

{% block facility_content %}
<!-- Report Period Selection -->
<section class="glass-card content-card">
    <div class="card-header-row">
        <h2 class="card-title">Report Period</h2>
        <div class="report-actions">
            <button type="button" class="btn-action export-btn" id="exportBtn">
                <span class="material-icons-round">download</span>
                Export Report
            </button>
        </div>
    </div>

    <form method="GET" id="reportForm" class="period-selector">
        <input type="hidden" name="period" id="periodInput" value="{{ period }}">

        <div class="period-options">
            <button type="button" class="glass-btn period-btn {% if period == 'week' %}active{% endif %}"
                onclick="selectPeriod('week')">Last Week</button>
            <button type="button" class="glass-btn period-btn {% if period == 'month' %}active{% endif %}"
                onclick="selectPeriod('month')">Last Month</button>
            <button type="button" class="glass-btn period-btn {% if period == 'quarter' %}active{% endif %}"
                onclick="selectPeriod('quarter')">Last Quarter</button>
            <button type="button" class="glass-btn period-btn {% if period == 'year' %}active{% endif %}"
                onclick="selectPeriod('year')">Last Year</button>
            <button type="button" class="glass-btn period-btn {% if period == 'custom' %}active{% endif %}"
                onclick="selectPeriod('custom')">Custom Range</button>
        </div>
        <div class="date-range" id="customDateRange" {% if period != 'custom' %}style="opacity: 0.5; pointer-events: none;" {% endif %}>
            <input type="date" class="glass-input date-input" name="start_date" id="startDate"
                value="{{ filters.start_date }}" onchange="selectPeriod('custom')">
            <span class="date-separator">to</span>
            <input type="date" class="glass-input date-input" name="end_date" id="endDate"
                value="{{ filters.end_date }}" onchange="selectPeriod('custom')">
            <button type="submit" class="glass-btn period-btn" style="margin-left: 10px; padding: 8px 12px;">Go</button>
        </div>
    </form>
</section>

<!-- Key Metrics Overview -->
<div class="stats-grid">
    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-blue">
                <span class="material-icons-round">event</span>
            </div>
        </div>
        <h3 class="stat-label">Total Incidents</h3>
        <p class="stat-value">{{ total_incidents }}</p>
        <div class="stat-change {% if total_change_pos %}positive{% else %}negative{% endif %}">
            <span class="material-icons-round">{% if total_change_pos %}trending_up{% else %}trending_down{% endif %}</span>
            <span>{{ total_change }}% {% if total_change_pos %}increase{% else %}decrease{% endif %}</span>
        </div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-green">
                <span class="material-icons-round">check_circle</span>
            </div>
        </div>
        <h3 class="stat-label">Response Rate</h3>
        <p class="stat-value">{{ response_rate }}%</p>
        <div class="stat-change {% if rate_change_pos %}positive{% else %}negative{% endif %}">
            <span class="material-icons-round">{% if rate_change_pos %}trending_up{% else %}trending_down{% endif %}</span>
            <span>{{ rate_change }}% {% if rate_change_pos %}improvement{% else %}drop{% endif %}</span>
        </div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-orange">
                <span class="material-icons-round">timer</span>
            </div>
        </div>
        <h3 class="stat-label">Avg Response Time</h3>
        <p class="stat-value">{{ avg_response_time }} min</p>
        <div class="stat-change {% if time_change_pos %}positive{% else %}negative{% endif %}">
            <span class="material-icons-round">{% if time_change_pos %}trending_down{% else %}trending_up{% endif %}</span>
            <span>{{ time_change }} min {% if time_change_pos %}faster{% else %}slower{% endif %}</span>
        </div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-red">
                <span class="material-icons-round">warning</span>
            </div>
        </div>
        <h3 class="stat-label">Critical Incidents</h3>
        <p class="stat-value">{{ critical_incidents }}</p>
        <div class="stat-change {% if critical_change_pos %}positive{% else %}negative{% endif %}">
            <span class="material-icons-round">{% if critical_change_pos %}trending_down{% else %}trending_up{% endif %}</span>
            <span>{{ critical_change }} {% if critical_change_pos %}fewer{% else %}more{% endif %} than prev</span>
        </div>
    </div>
</div>

<!-- Incident Trends Chart -->
<section class="glass-card content-card">
    <div class="card-header-row">
        <h2 class="card-title">Incident Trends</h2>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <div class="chart-title">Incident Volume (Last 7 Days in Range)</div>
            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-color medical"></div><span>Medical</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color fire"></div><span>Fire</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color accident"></div><span>Accident</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color crime"></div><span>Crime/Security</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color natural"></div><span>Natural Disaster</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color other"></div><span>Other</span>
                </div>
            </div>
        </div>

        <div class="trend-chart" style="height: 300px; padding-top: 20px;">
            <!-- Simple Y-Axis Labels (Improvised) -->
            <div class="y-axis">
                <div class="y-label">High</div>
                <div class="y-label">Low</div>
            </div>

            <div class="chart-area">
                <div class="grid-lines">
                    <div class="grid-line"></div>
                    <div class="grid-line"></div>
                    <div class="grid-line"></div>
                </div>

                <div class="chart-data">
                    {% for day in trend_data %}
                    <div class="data-group">
                        <div class="bar-stack-container"
                            style="display:flex; align-items:flex-end; height: 100%; gap: 4px;">
                            {% if day.counts.medical > 0 %}
                                <div class="bar medical"
                                    style="height: {{ day.counts.medical }}%; width: 8px;" title="Medical"></div>
                            {% endif %}
                            {% if day.counts.fire > 0 %}
                                <div class="bar fire"
                                    style="height: {{ day.counts.fire }}%; width: 8px;" title="Fire"></div>
                            {% endif %}
                            {% if day.counts.security > 0 %}
                                <div class="bar security"
                                    style="height: {{ day.counts.security }}%; width: 8px;" title="Security"></div>
                            {% endif %}
                            {% if day.counts.equipment > 0 %}
                                <div class="bar equipment"
                                    style="height: {{ day.counts.equipment }}%; width: 8px;" title="Equipment"></div>
                            {% endif %}
                            {% if day.counts.other > 0 %}
                                <div class="bar other"
                                    style="height: {{ day.counts.other }}%; width: 8px;" title="Other"></div>
                            {% endif %}
                        </div>
                        <div class="x-label">{{ day.label }}</div>
                    </div>
                    {% empty %}
                    <p style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:#888;">No
                        data for chart</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Detailed Analytics -->
<div class="analytics-grid">
    <!-- Incident Distribution -->
    <section class="glass-card content-card">
        <div class="card-header-row">
            <h2 class="card-title">Incident Distribution</h2>
        </div>

        <div class="distribution-chart">
            <!-- Dynamic Conic Gradient Pie Chart -->
            <div class="pie-chart" style="
                width: 200px; 
                height: 200px; 
                border-radius: 50%;
                background: #eee; /* Fallback */
                position: relative;">
                <!-- Center Hole for Donut Effect -->
                <div class="pie-center-hole"
                    style="position: absolute; width: 60%; height: 60%; background: #ffffff; border-radius: 50%; top: 20%; left: 20%;">
                </div>
            </div>

            <!-- Hidden data for JS to build chart nicely -->
            <div id="distData" style="display:none;">
                {% for item in dist_list %}
                <div data-key="{{ item.key }}" data-pct="{{ item.pct }}"></div>
                {% endfor %}
            </div>

            <div class="distribution-legend">
                {% for item in dist_list %}
                <div class="legend-item">
                    <div class="legend-color {{ item.key }}"></div>
                    <div class="legend-info">
                        <span class="legend-label">{{ item.label }}</span>
                        <span class="legend-value">{{ item.count }} ({{ item.pct }}%)</span>
                    </div>
                </div>
                {% empty %}
                <p>No incidents in this period.</p>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Response Performance -->
    <section class="glass-card content-card">
        <div class="card-header-row">
            <h2 class="card-title">Top Performers</h2>
        </div>

        <div class="performers-list">
            {% for responder in top_responders %}
            <div class="glass-card performer-item">
                <div class="performer-avatar">
                    <span class="material-icons-round">person</span>
                </div>
                <div class="performer-info">
                    <div class="performer-name">{{ responder.user.get_full_name }}</div>
                    <div class="performer-role">{{ responder.skills }}</div>
                </div>
                <div class="performer-stats">
                    <div class="stat-value">{{ responder.completed_count }}</div>
                    <div class="stat-label">Resolved</div>
                </div>
                {% if forloop.first %}
                <div class="performer-badge">
                    <span class="material-icons-round">emoji_events</span>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <p style="padding: 20px; color: #666; text-align: center;">No performer data available for this period.</p>
            {% endfor %}
        </div>
    </section>
</div>

<script>
    function selectPeriod(period) {
        document.getElementById('periodInput').value = period;
        const form = document.getElementById('reportForm');

        // Show/Hide Custom Range
        const customRange = document.getElementById('customDateRange');
        if (period === 'custom') {
            customRange.style.opacity = '1';
            customRange.style.pointerEvents = 'auto';
            // Don't submit immediately if custom
        } else {
            customRange.style.opacity = '0.5';
            customRange.style.pointerEvents = 'none';
            form.submit();
        }
    }

    // Export Handler
    document.getElementById('exportBtn').addEventListener('click', function () {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('export', 'csv');
        window.location.href = window.location.pathname + '?' + urlParams.toString();
    });

    // Pie Chart Generator
    document.addEventListener('DOMContentLoaded', function () {
        const items = document.querySelectorAll('#distData div');
        let gradientStr = [];
        let currentPct = 0;

        const colors = {
            'medical': '#3498db',
            'fire': '#e74c3c',
            'security': '#f1c40f',
            'equipment': '#9b59b6',
            'other': '#95a5a6'
        };

        if (items.length > 0) {
            items.forEach(item => {
                const key = item.dataset.key;
                const pct = parseFloat(item.dataset.pct);
                const color = colors[key] || '#ccc';
                const start = currentPct;
                const end = currentPct + pct;
                // Fix: Conic gradient syntax is 'color start% end%'
                // Only add if pct > 0 to avoid artifacts
                if (pct > 0) {
                    gradientStr.push(`${color} ${start}% ${end}%`);
                }
                currentPct += pct;
            });

            const pieChart = document.querySelector('.pie-chart');
            if (pieChart && gradientStr.length > 0) {
                pieChart.style.background = `conic-gradient(${gradientStr.join(', ')})`;
            }
        }
    });
</script>
{% endblock %}