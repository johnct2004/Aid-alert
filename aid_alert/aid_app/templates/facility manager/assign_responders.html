{% extends 'facility manager/base_facility.html' %}
{% load static %}

{% block page_title %}Assign Responders{% endblock %}
{% block content_title %}Assign Responders{% endblock %}

{% block facility_css %}
<link rel="stylesheet" href="{% static 'css/facility manager/assign_responders.css' %}">
{% endblock %}

{% block facility_content %}
<!-- Stats Overview -->
<div class="stats-grid">
    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-blue">
                <span class="material-icons-round">people</span>
            </div>
        </div>
        <h3 class="stat-label">Total Responders</h3>
        <p class="stat-value" id="totalResponders">{{ total_responders }}</p>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-green">
                <span class="material-icons-round">check_circle</span>
            </div>
        </div>
        <h3 class="stat-label">Available</h3>
        <p class="stat-value" id="availableResponders">{{ available_responders }}</p>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-orange">
                <span class="material-icons-round">work</span>
            </div>
        </div>
        <h3 class="stat-label">On Duty</h3>
        <p class="stat-value" id="onDutyResponders">{{ on_duty_responders }}</p>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-red">
                <span class="material-icons-round">do_not_disturb</span>
            </div>
        </div>
        <h3 class="stat-label">Unavailable</h3>
        <p class="stat-value" id="unavailableResponders">{{ unavailable_responders }}</p>
    </div>
</div>

<!-- Active Assignments (Placeholder for now until assignment logic builds) -->
<section class="glass-card content-card">
    <div class="card-header-row">
        <h2 class="card-title">Active Assignments</h2>
        <button class="btn-action" id="newAssignmentBtn">
            <span class="material-icons-round">add</span>
            New Assignment
        </button>
    </div>

    <div class="table-responsive">
        <table class="glass-table">
            <thead>
                <tr>
                    <th>Assignment ID</th>
                    <th>Responder</th>
                    <th>Incident Type</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Assigned Time</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for assignment in active_assignments %}
                <tr>
                    <td>{{ assignment.incident_id }}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            {% if assignment.assigned_responder.profile.profile_picture %}
                            <img src="{{ assignment.assigned_responder.profile.profile_picture.url }}" alt="Profile"
                                style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                            <span class="material-icons-round"
                                style="background: rgba(255,255,255,0.1); padding: 5px; border-radius: 50%; font-size: 20px;">person</span>
                            {% endif %}
                            {{ assignment.assigned_responder.user.get_full_name|default:assignment.assigned_responder.user.username }}
                        </div>
                    </td>
                    <td>{{ assignment.get_incident_type_display }}</td>
                    <td>{{ assignment.location|truncatechars:30 }}</td>
                    <td>
                        <span class="status-badge {{ assignment.status|slugify }}">
                            {{ assignment.get_status_display }}
                        </span>
                    </td>
                    <td>{{ assignment.updated_at|timesince }} ago</td>
                    <td>
                        <button class="btn-icon view-details-btn" data-id="{{ assignment.incident_id }}"
                            data-type="{{ assignment.get_incident_type_display }}"
                            data-severity="{{ assignment.get_severity_display }}"
                            data-location="{{ assignment.location }}" data-status="{{ assignment.get_status_display }}"
                            data-responder="{{ assignment.assigned_responder.user.get_full_name|default:assignment.assigned_responder.user.username }}"
                            data-description="{{ assignment.description }}" title="View Details">
                            <span class="material-icons-round">visibility</span>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-4">No active assignments to display.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- Responder Pool -->
<section class="glass-card content-card">
    <div class="card-header-row">
        <h2 class="card-title">Responder Pool</h2>
        <div class="filters-wrapper">
            <form method="GET" action="." style="display: flex; gap: 16px; flex-wrap: wrap; width: 100%;">
                <div class="search-box">
                    <span class="material-icons-round search-icon">search</span>
                    <input type="text" name="search" class="search-input glass-input" placeholder="Search responders..."
                        value="{{ search_query }}">
                </div>
                <div class="select-group">
                    <select name="status" class="glass-select" onchange="this.form.submit()">
                        <option value="">All Status</option>
                        <option value="available" {% if status_filter == 'available' %}selected{% endif %}>Available
                        </option>
                        <option value="on-duty" {% if status_filter == 'on_duty' %}selected{% endif %}>On Duty</option>
                        <option value="unavailable" {% if status_filter == 'unavailable' %}selected{% endif %}>Unavailable
                        </option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <div class="responders-grid">
        {% for responder in responders %}
        <div class="glass-card responder-card {{ responder.status|default:'unavailable' }}">
            <div class="responder-avatar">
                {% if responder.profile_picture %}
                <img src="{{ responder.profile_picture.url }}" alt="{{ responder.user.get_full_name }}"
                    style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
                {% else %}
                <span class="material-icons-round">person</span>
                {% endif %}
            </div>
            <div class="responder-info">
                <h4>{{ responder.user.get_full_name|default:responder.user.username }}</h4>
                <p class="responder-role">{{ responder.role|default:"Medical Responder" }}</p>
                <div class="responder-skills">
                    {% for skill in responder.skills.all %}
                    <span class="skill-tag">{{ skill.name }}</span>
                    {% empty %}
                    <span class="skill-tag">General</span>
                    {% endfor %}
                </div>
            </div>
            <div class="responder-status">
                <span class="status-dot {{ responder.status|default:'unavailable' }}"></span>
                <span>{{ responder.get_status_display|default:responder.status|title }}</span>
            </div>
            <button class="btn-secondary btn-assign" data-id="{{ responder.id }}" {% if responder.status != 'available' %} disabled {% endif %}>Assign</button>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-8">
            <p>No responders found.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination Controls -->
    {% if responders.has_other_pages %}
    <div class="pagination-wrapper glass-card"
        style="margin-top: 2rem; display: flex; justify-content: center; padding: 1rem;">
        <div class="pagination">
            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">&laquo;</a>

            {% for i in custom_page_range %}
            {% if i == '...' %}
            <span class="page-link disabled">...</span>
            {% elif responders.number == i %}
            <span class="page-link active">{{ i }}</span>
            {% else %}
            <a class="page-link"
                href="?page={{ i }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ i }}</a>
            {% endif %}
            {% endfor %}

            <a class="page-link" href="?page={{ responders.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">&raquo;</a>
        </div>
    </div>
    {% endif %}
</section>

<!-- New Assignment Modal -->
<div class="modal-overlay" id="newAssignmentModal">
    <div class="glass-modal">
        <div class="modal-header">
            <h2>New Incident Assignment</h2>
        </div>
        <form id="newAssignmentForm">
            <div class="form-group">
                <label>Incident Type</label>
                <select name="incident_type" class="glass-input" required>
                    <option value="medical">Medical Emergency</option>
                    <option value="fire">Fire Hazard</option>
                    <option value="accident">Accident</option>
                    <option value="crime">Crime/Security</option>
                    <option value="natural">Natural Disaster</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label>Severity</label>
                <select name="severity" class="glass-input" required>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="form-group">
                <label>Location</label>
                <input type="text" name="location" class="glass-input" placeholder="e.g., Wing C, Room 304" required>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea name="description" class="glass-textarea" rows="3"
                    placeholder="Brief details about the incident..." required></textarea>
            </div>

            <div class="form-group">
                <label>Assign Responder</label>
                <select name="responder_id" class="glass-input" id="responderSelect">
                    <option value="">-- Select Responder --</option>
                    {% for resp in responders %}
                    {% if resp.status == 'available' %}
                    <option value="{{ resp.id }}">{{ resp.user.get_full_name|default:resp.user.username }} (Available)
                    </option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="closeModalBtn">Cancel</button>
                <button type="submit" class="btn-primary">Create & Assign</button>
            </div>
        </form>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal-overlay" id="viewDetailsModal">
    <div class="glass-modal">
        <div class="modal-header">
            <h2>Incident Details</h2>
        </div>
        <div class="details-content">
            <div class="detail-row">
                <span class="detail-label">Incident ID:</span>
                <span class="detail-value" id="viewId"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Type:</span>
                <span class="detail-value" id="viewType"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Severity:</span>
                <span class="detail-value" id="viewSeverity"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Location:</span>
                <span class="detail-value" id="viewLocation"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span class="detail-value" id="viewStatus"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Assigned To:</span>
                <span class="detail-value" id="viewResponder"></span>
            </div>
            <div class="detail-row full-width">
                <span class="detail-label">Description:</span>
                <p class="detail-text" id="viewDescription"></p>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-primary" id="closeViewModalBtn">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block facility_js %}
<script src="{% static 'js/facility_manager/assign_responders.js' %}"></script>
{% endblock %}