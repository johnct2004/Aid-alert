{% extends 'facility manager/base_facility.html' %}
{% load static %}

{% block page_title %}Notifications{% endblock %}
{% block content_title %}Notifications{% endblock %}

{% block facility_css %}
<link rel="stylesheet" href="{% static 'css/facility manager/facility_notifications.css' %}">
{% endblock %}

{% block facility_content %}
<!-- CSRF Token for AJAX -->
<form style="display:none;">{% csrf_token %}</form>

<!-- Notification Overview -->
<div class="stats-grid">
    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-red">
                <span class="material-icons-round">error</span>
            </div>
        </div>
        <h3 class="stat-label">Critical Alerts</h3>
        <p class="stat-value" id="criticalAlerts">{{ critical_alerts }}</p>
        <div class="stat-change negative">
            <span class="material-icons-round">trending_up</span>
            <span>Action Required</span>
        </div>
    </div>
    <!-- ... (keep other stat cards unchanged, skipping for brevity in replacement if possible, but replace requires contiguous block. I will just target the top part to insert form) -->


    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-orange">
                <span class="material-icons-round">warning</span>
            </div>
        </div>
        <h3 class="stat-label">High Priority</h3>
        <p class="stat-value" id="highPriority">{{ high_priority }}</p>
        <div class="stat-change positive">
            <span class="material-icons-round">trending_down</span>
            <span>Active Issues</span>
        </div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-blue">
                <span class="material-icons-round">info</span>
            </div>
        </div>
        <h3 class="stat-label">Information</h3>
        <p class="stat-value" id="information">{{ info_alerts }}</p>
        <div class="stat-change positive">
            <span class="material-icons-round">trending_up</span>
            <span>Updates</span>
        </div>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-green">
                <span class="material-icons-round">check_circle</span>
            </div>
        </div>
        <h3 class="stat-label">Resolved Today</h3>
        <p class="stat-value" id="resolvedToday">{{ resolved_today }}</p>
        <div class="stat-change positive">
            <span class="material-icons-round">trending_up</span>
            <span>Incidents Closed</span>
        </div>
    </div>
</div>

<!-- Active Notifications & Management Combined -->
<section class="glass-card content-card">
    <div class="card-header-row">
        <h2 class="card-title">Active Notifications</h2>
        <div class="notification-actions" style="display: flex; gap: 1rem;">
            <div class="view-toggle">
                <button class="toggle-btn active" data-view="list">
                    <span class="material-icons-round">list</span>
                </button>
                <button class="toggle-btn" data-view="grid">
                    <span class="material-icons-round">grid_view</span>
                </button>
            </div>
            <button class="btn-action mark-all-read" onclick="markAllRead()" style="margin-left: 10px;">
                <span class="material-icons-round">done_all</span>
                Mark All Read
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="notification-filters" style="margin-bottom: 20px;">
        <div class="filters-wrapper">
            <div class="search-box">
                <span class="material-icons-round search-icon">search</span>
                <input type="text" class="glass-input search-input" id="notifSearch"
                    placeholder="Search notifications..." onkeyup="filterNotifications()">
            </div>
            <select class="glass-select filter-select" id="typeFilter" onchange="filterNotifications()">
                <option value="all">All Types</option>
                <option value="critical">Critical</option>
                <option value="high">High Priority</option>
                <option value="medium">Medium Priority</option>
                <option value="low">Low Priority</option>
                <option value="info">Information</option>
            </select>
        </div>
    </div>

    <div class="notifications-list" id="notificationsList">
        {% for notif in notifications %}
        <div class="glass-card notification-item {% if notif.notification_type == 'critical' %}critical{% elif notif.notification_type == 'info' %}information{% else %}{{ notif.notification_type }}-priority{% endif %} unread"
            data-type="{{ notif.notification_type }}" data-category="{{ notif.category }}" id="notif-{{ notif.id }}">
            <div class="notification-icon">
                {% if notif.notification_type == 'critical' %}
                <span class="material-icons-round">error</span>
                {% elif notif.notification_type == 'high' %}
                <span class="material-icons-round">warning</span>
                {% elif notif.notification_type == 'info' %}
                <span class="material-icons-round">info</span>
                {% else %}
                <span class="material-icons-round">notifications</span>
                {% endif %}
            </div>
            <div class="notification-content">
                <div class="notification-header">
                    <h4 class="notification-title">{{ notif.title }}</h4>
                    <span class="notification-time">{{ notif.created_at|timesince }} ago</span>
                </div>
                <p class="notification-message">{{ notif.message }}</p>
                <div class="notification-meta">
                    <span class="notification-category">{{ notif.get_category_display }}</span>
                    <span class="notification-priority">{{ notif.get_notification_type_display }}</span>
                </div>
            </div>
            <div class="notification-actions">
                <button class="btn-sm action-btn mark-read" onclick="markRead({{ notif.id }})">Mark Read</button>
                {% if notif.related_incident %}
                <button class="btn-sm action-btn view-details"
                    onclick="window.location.href='{% url 'aid_app:facility_incident_log' %}?open_incident={{ notif.related_incident.id }}'">View
                    Incident</button>

                <!-- Forward to Admin logic for Blood Loss -->
                {% if 'Blood Loss' in notif.title or 'blood loss' in notif.title %}
                <button class="btn-sm action-btn" style="background: #e74c3c; color: white; border: none;"
                    onclick="forwardToAdmin('{{ notif.related_incident.id }}', this)">
                    <span class="material-icons-round"
                        style="font-size: 14px; vertical-align: middle;">forward_to_inbox</span>
                    Forward to Admin
                </button>
                {% endif %}
                {% endif %}
            </div>
            <div class="notification-status unread-indicator"></div>
        </div>
        {% empty %}
        <div class="empty-state"
            style="text-align: center; padding: 40px; color: #999; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
            <span class="material-icons-round"
                style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">notifications_off</span>
            <p style="margin: 0; font-size: 1rem;">No active notifications</p>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Notification History -->
<section class="glass-card content-card">
    <div class="card-header-row">
        <h2 class="card-title">Recent History</h2>
    </div>

    <div class="history-timeline">
        {% for notif in history_notifications %}
        <div class="timeline-item resolved">
            <div class="timeline-marker">
                <span class="material-icons-round">check_circle</span>
            </div>
            <div class="timeline-content glass-card">
                <div class="timeline-header">
                    <h5 class="timeline-title">{{ notif.title }}</h5>
                    <span class="timeline-time">{{ notif.created_at|timesince }} ago</span>
                </div>
                <p class="timeline-description">{{ notif.message }} (Marked Read)</p>
                <div class="timeline-meta">
                    <span class="timeline-status">Resolved</span>
                    <span class="timeline-category">{{ notif.get_category_display }}</span>
                </div>
            </div>
        </div>
        {% empty %}
        <p style="text-align: center; color: #888; padding: 20px;">No history available.</p>
        {% endfor %}
    </div>
</section>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function markRead(id) {
        const csrftoken = getCookie('csrftoken');
        if (!csrftoken) {
            alert('Session Error: CSRF Token missing. Please refresh the page.');
            return;
        }

        fetch(`/api/notifications/mark-read/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.ok) {
                    // Animate removal
                    const item = document.getElementById(`notif-${id}`);
                    if (item) {
                        item.style.opacity = '0';
                        setTimeout(() => item.remove(), 300);
                    }
                } else {
                    alert('Error: Could not mark notification as read.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error. Please check your connection.');
            });
    }

    function markAllRead() {
        if (!confirm('Mark all notifications as read?')) return;

        fetch(`/api/notifications/mark-all-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                }
            });
    }

    // Client-side filtering
    function filterNotifications() {
        const searchText = document.getElementById('notifSearch').value.toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;
        const items = document.querySelectorAll('.notifications-list .notification-item');

        items.forEach(item => {
            const title = item.querySelector('.notification-title').innerText.toLowerCase();
            const message = item.querySelector('.notification-message').innerText.toLowerCase();
            const type = item.getAttribute('data-type');

            const matchesSearch = title.includes(searchText) || message.includes(searchText);
            const matchesType = typeFilter === 'all' || type === typeFilter;

            if (matchesSearch && matchesType) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // View Toggle Logic
    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtns = document.querySelectorAll('.toggle-btn');
        const listContainer = document.getElementById('notificationsList');

        // Check local storage for preference
        const savedView = localStorage.getItem('notificationView') || 'list';
        setview(savedView);

        toggleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const viewType = btn.dataset.view;
                setview(viewType);
            });
        });

        function setview(viewType) {
            // Update buttons
            toggleBtns.forEach(btn => {
                if (btn.dataset.view === viewType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Update container
            if (viewType === 'grid') {
                listContainer.classList.add('grid-view');
            } else {
                listContainer.classList.remove('grid-view');
            }

            // Save preference
            localStorage.setItem('notificationView', viewType);
        }
    });

    function forwardToAdmin(incidentId, btnElement) {
        if (!confirm('Forward this urgent request to Admin for donor search?')) return;

        const originalText = btnElement.innerHTML;
        btnElement.innerHTML = 'Forwarding...';
        btnElement.disabled = true;

        fetch('/api/forward-medical-alert/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ incident_id: incidentId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Request forwarded to Admin successfully.');
                    btnElement.innerHTML = 'Forwarded';
                    // btnElement.style.background = '#2ecc71'; 
                } else {
                    alert('Error: ' + data.message);
                    btnElement.innerHTML = originalText;
                    btnElement.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error.');
                btnElement.innerHTML = originalText;
                btnElement.disabled = false;
            });
    }
</script>
{% endblock %}