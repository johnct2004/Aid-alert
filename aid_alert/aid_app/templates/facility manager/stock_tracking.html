{% extends 'facility manager/base_facility.html' %}
{% load static %}

{% block page_title %}Stock Tracking{% endblock %}
{% block content_title %}Stock Tracking{% endblock %}

{% block facility_css %}
<link rel="stylesheet" href="{% static 'css/facility manager/stock_tracking.css' %}">
{% endblock %}

{% block facility_content %}
<!-- Stats Overview -->
<div class="stats-grid">
    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-blue">
                <span class="material-icons-round">inventory_2</span>
            </div>
        </div>
        <h3 class="stat-label">Total Items</h3>
        <p class="stat-value" id="totalItems">{{ total_items }}</p>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-green">
                <span class="material-icons-round">check_circle</span>
            </div>
        </div>
        <h3 class="stat-label">In Stock</h3>
        <p class="stat-value" id="inStock">{{ in_stock }}</p>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-orange">
                <span class="material-icons-round">warning</span>
            </div>
        </div>
        <h3 class="stat-label">Low Stock</h3>
        <p class="stat-value" id="lowStock">{{ low_stock }}</p>
    </div>

    <div class="glass-card stat-card">
        <div class="stat-header">
            <div class="stat-icon icon-red">
                <span class="material-icons-round">error</span>
            </div>
        </div>
        <h3 class="stat-label">Out of Stock</h3>
        <p class="stat-value" id="outOfStock">{{ out_of_stock }}</p>
    </div>
</div>

<!-- Stock Chart -->
<section class="glass-card content-card" style="margin-bottom: 40px;">
    <div class="card-header-row">
        <h2 class="card-title">Stock Distribution (by Kit Type)</h2>
    </div>

    <div class="chart-container">
        <div class="chart-placeholder">
            <div class="chart-graph">
                <!-- Y-axis (Simplified dynamic scale) -->
                <div class="y-axis">
                    <div class="y-label">{{ max_val }}</div>
                    <div class="y-label">{{ max_val|title|slice:":2" }}...</div> <!-- Rough approximation -->
                    <div class="y-label">0</div>
                </div>

                <!-- Chart area with gridlines -->
                <div class="chart-area">
                    <div class="grid-lines">
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                    </div>
                    <div class="chart-bars">
                        {% for data in chart_data %}
                        <div class="chart-bar" style="height: {{ data.height_percent }}%; width: 60px;">
                            <div class="bar-value">{{ data.value }}</div>
                            <div class="bar-tooltip">{{ data.label }}: {{ data.value }}</div>
                        </div>
                        {% empty %}
                        <div
                            style="display:flex; justify-content:center; align-items:center; width:100%; height:100%; color:#888;">
                            No data available
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- X-axis labels -->
            <div class="x-axis-labels">
                {% for data in chart_data %}
                <div class="x-label" style="width: 60px; word-wrap: break-word; font-size: 0.8rem;">
                    {{ data.label|truncatechars:10 }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<!-- Inventory Table -->
<section class="glass-card content-card">
    <div class="card-header-row">
        <h2 class="card-title">Inventory Details</h2>
    </div>

    <form id="filterForm" method="get" class="filters-wrapper">
        <div class="search-box">
            <span class="material-icons-round search-icon">search</span>
            <input type="text" name="search" class="search-input glass-input" placeholder="Search items..."
                value="{{ request.GET.search }}">
        </div>
        <div class="select-group">
            <select name="category" class="glass-select filter-select"
                onchange="document.getElementById('filterForm').submit()">
                <option value="">All Categories</option>
                {% for category in categories %}
                <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category }}
                </option>
                {% endfor %}
            </select>
            <select name="status" class="glass-select filter-select"
                onchange="document.getElementById('filterForm').submit()">
                <option value="">All Status</option>
                <option value="in-stock" {% if selected_status == 'in-stock' %}selected{% endif %}>In Stock</option>
                <option value="low-stock" {% if selected_status == 'low-stock' %}selected{% endif %}>Low Stock</option>
                <option value="out-of-stock" {% if selected_status == 'out-of-stock' %}selected{% endif %}>Out of Stock
                </option>
            </select>
        </div>
    </form>

    <div class="table-responsive">
        <table class="glass-table">
            <thead>
                <tr>
                    <th>Item ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Current Stock</th>
                    <th>Min Level</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr id="item-row-{{ item.id }}">
                    <td>ITM-{{ item.id|stringformat:"03d" }}</td>
                    <td class="font-bold">{{ item.name }}</td>
                    <td>{{ item.kit.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.min_quantity }}</td>
                    <td>
                        {% if item.quantity == 0 %}
                        <span class="status-badge status-expired">Out of Stock</span>
                        {% elif item.quantity <= item.min_quantity %} <span class="status-badge status-maintenance">Low
                            Stock</span>
                            {% else %}
                            <span class="status-badge status-available">In Stock</span>
                            {% endif %}
                    </td>
                    <td>{{ item.updated_at|timesince }} ago</td>
                    <td>
                        <button class="btn-action update-stock-btn" data-id="{{ item.id }}" data-name="{{ item.name }}"
                            data-quantity="{{ item.quantity }}" data-kit="{{ item.kit.name }}">
                            Update
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center py-4">No items found in inventory.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    {% if items.has_other_pages %}
    <div class="pagination">
        {% if items.has_previous %}
        <a href="?page={{ items.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}"
            class="pagination-btn">
            <span class="material-icons-round">chevron_left</span>
        </a>
        {% else %}
        <span class="pagination-btn disabled" style="opacity: 0.5; cursor: default;">
            <span class="material-icons-round">chevron_left</span>
        </span>
        {% endif %}

        <div class="pagination-numbers">
            <span class="pagination-number active">{{ items.number }}</span>
            <span class="pagination-dots">of</span>
            <span class="pagination-number">{{ items.paginator.num_pages }}</span>
        </div>

        {% if items.has_next %}
        <a href="?page={{ items.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}"
            class="pagination-btn">
            <span class="material-icons-round">chevron_right</span>
        </a>
        {% else %}
        <span class="pagination-btn disabled" style="opacity: 0.5; cursor: default;">
            <span class="material-icons-round">chevron_right</span>
        </span>
        {% endif %}
    </div>
    {% endif %}
</section>



<!-- Update Stock Modal -->
<div id="updateStockModal" class="modal-overlay hidden">
    <div class="glass-modal">
        <div class="modal-header">
            <h2>Update Stock</h2>
            <button class="close-modal" type="button" onclick="closeUpdateModal()">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <div class="modal-content">
            <div class="item-info-summary">
                <h3 id="modalItemName">Item Name</h3>
                <p id="modalKitName" class="text-sm text-gray">Kit Name</p>
            </div>

            <form id="updateStockForm">
                <div class="form-group">
                    <label class="form-label">New Quantity</label>
                    <div class="input-wrapper">
                        <span class="material-icons-round input-icon">inventory_2</span>
                        <input type="number" id="updateQuantity" class="glass-input" min="0" required>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeUpdateModal()">Cancel</button>
                    <button type="submit" class="btn-action">
                        <span class="material-icons-round">save</span>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block facility_js %}
<script>
    console.log("INLINE JS LOADED");

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    let currentItemId = null;

    function openUpdateModal(itemId, itemName, currentQty, kitName) {
        console.log('Opening modal for:', itemId, itemName);
        currentItemId = itemId;
        const nameEl = document.getElementById('modalItemName');
        const kitEl = document.getElementById('modalKitName');
        const qtyInput = document.getElementById('updateQuantity');

        if (nameEl) nameEl.textContent = itemName;
        if (kitEl) kitEl.textContent = kitName;
        if (qtyInput) qtyInput.value = currentQty;

        const modal = document.getElementById('updateStockModal');
        if (modal) {
            modal.classList.remove('hidden');
            void modal.offsetWidth; // Force reflow
            modal.classList.add('visible');
        } else {
            alert("Error: Modal not found!");
        }
    }

    function closeUpdateModal() {
        const modal = document.getElementById('updateStockModal');
        if (modal) {
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.classList.add('hidden');
                currentItemId = null;
            }, 300);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOM Content Loaded - Stock Tracking");

        // Event Delegation
        document.body.addEventListener('click', function (e) {
            const btn = e.target.closest('.update-stock-btn');
            if (btn) {
                e.preventDefault(); // Stop any default behavior
                console.log("Update button clicked", btn.dataset);
                const { id, name, quantity, kit } = btn.dataset;
                openUpdateModal(id, name, quantity, kit);
            }

            const modal = document.getElementById('updateStockModal');
            if (e.target === modal) {
                closeUpdateModal();
            }
        });

        const form = document.getElementById('updateStockForm');
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                if (!currentItemId) {
                    alert("No item selected!");
                    return;
                }

                const newQty = document.getElementById('updateQuantity').value;
                const btn = form.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;

                btn.innerHTML = '<span class="material-icons-round spin">sync</span> Updating...';
                btn.disabled = true;

                fetch('/api/stock/update/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        item_id: currentItemId,
                        quantity: parseInt(newQty)
                    })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const row = document.getElementById(`item-row-${currentItemId}`);
                            if (row) {
                                row.cells[3].textContent = newQty;
                                row.cells[5].innerHTML = `<span class="status-badge ${data.status_class}">${data.new_status}</span>`;
                                const btnArg = row.querySelector('.update-stock-btn');
                                if (btnArg) btnArg.dataset.quantity = newQty;
                            }
                            closeUpdateModal();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Update failed: ' + error);
                    })
                    .finally(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    });
            });
        } else {
            console.error("Form not found!");
        }
    });
</script>
{% endblock %}