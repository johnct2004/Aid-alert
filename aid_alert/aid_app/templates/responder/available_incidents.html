{% extends 'responder/base_responder.html' %}
{% load static %}

{% block page_title %}Available Incidents{% endblock %}
{% block content_title %}Available Incidents{% endblock %}

{% block responder_css %}
<link rel="stylesheet" href="{% static 'css/responder/available_incidents.css' %}">
{% endblock %}

{% block responder_content %}
<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon available-icon">
            <span class="material-icons-round">list_alt</span>
        </div>
        <div>
            <h3 class="stat-label">Available Incidents</h3>
            <p class="stat-value">12</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon high-priority-icon">
            <span class="material-icons-round">priority_high</span>
        </div>
        <div>
            <h3 class="stat-label">High Priority</h3>
            <p class="stat-value">3</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon nearby-icon">
            <span class="material-icons-round">location_on</span>
        </div>
        <div>
            <h3 class="stat-label">Within 5km</h3>
            <p class="stat-value">7</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon medical-icon">
            <span class="material-icons-round">medical_services</span>
        </div>
        <div>
            <h3 class="stat-label">Medical</h3>
            <p class="stat-value">5</p>
        </div>
    </div>
</div>

<!-- Available Incidents Table Section -->
<section class="glass-card content-card">
    <div class="card-header-row">
        <h2 class="card-title">Available Incidents</h2>
        <div class="filters-wrapper">
            <div class="search-box">
                <span class="material-icons-round search-icon">search</span>
                <input type="text" class="search-input" placeholder="Search incidents...">
            </div>
            <div class="dropdowns">
                <select class="filter-select" id="urgency-filter">
                    <option value="">All Urgency</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                <select class="filter-select" id="type-filter">
                    <option value="">All Types</option>
                    <option value="medical">Medical</option>
                    <option value="fire">Fire</option>
                    <option value="accident">Accident</option>
                    <option value="police">Police</option>
                </select>
                <select class="filter-select" id="distance-filter">
                    <option value="">All Distances</option>
                    <option value="1">Within 1km</option>
                    <option value="5">Within 5km</option>
                    <option value="10">Within 10km</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Location</th>
                    <th>Urgency</th>
                    <th>Time Reported</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for incident in incidents %}
                <tr>
                    <td>{{ incident.incident_id }}</td>
                    <td><span class="incident-type {{ incident.incident_type }}">{{ incident.get_incident_type_display
                            }}</span></td>
                    <td>{{ incident.location }}</td>
                    <td>
                        <span class="badge {% if incident.severity == 'critical' or incident.severity == 'high' %}badge-inactive{% else %}badge-active{% endif %}">
                            {{ incident.get_severity_display }}
                        </span>
                    </td>
                    <td>{{ incident.created_at|timesince }} ago</td>
                    <td>
                        <!-- Debug info -->
                        <small>Debug: ID="{{ incident.incident_id }}"</small><br>
                        <button class="btn-action" onclick="acceptIncident('{{ incident.incident_id }}')">
                            Accept
                        </button>
                        <!-- Also try direct link for testing -->
                        <br><small>Or <a href="/accept-incident/?id={{ incident.incident_id }}">click here</a></small>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align:center; padding: 20px;">No available incidents at the moment.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination">
        <button class="pagination-btn" disabled>Previous</button>
        <span class="page-info">Showing 1-12 of 45 incidents</span>
        <button class="pagination-btn">Next</button>
    </div>
</section>
{% endblock %}

{% block responder_js %}
<script>
    function acceptIncident(incidentId) {
        console.log('acceptIncident called with:', incidentId);
        console.log('Type of incidentId:', typeof incidentId);
        console.log('Length of incidentId:', incidentId ? incidentId.length : 'undefined');
        
        if (!incidentId) {
            console.error('ERROR: incidentId is undefined or null!');
            alert('Error: Incident ID is missing. Please refresh the page and try again.');
            return;
        }
        
        if (confirm(`Are you sure you want to accept incident ${incidentId}?`)) {
            console.log('User confirmed acceptance');

            // Update availability toggle to unavailable when accepting incident
            // Note: Header toggle ID is from base_responder.html
            const headerToggle = document.getElementById('header-availability-toggle');
            if (headerToggle) {
                headerToggle.checked = false;
                // Trigger change event if needed or update text manually, 
                // but base_responder handles the change event
                headerToggle.dispatchEvent(new Event('change'));
            }

            showNotification(`Incident ${incidentId} accepted! Redirecting...`);
            const redirectUrl = `/accept-incident/?id=${incidentId}`;
            console.log('About to redirect to:', redirectUrl);

            // Try immediate redirect first
            console.log('Attempting immediate redirect...');
            window.location.href = redirectUrl;

            // Fallback to setTimeout if immediate doesn't work
            setTimeout(() => {
                console.log('Fallback redirect...');
                window.location.href = redirectUrl;
            }, 1000);
        } else {
            console.log('User cancelled acceptance');
        }
    }

    // Notification function (Reusing the one from base_responder logic ideally, but ensuring local works too)
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'glass-alert';
        notification.innerHTML = `<span class="material-icons-round">check_circle</span> <span>${message}</span>`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Search functionality
    document.querySelector('.search-input').addEventListener('input', function (e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('.data-table tbody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    // Filter functionality
    document.getElementById('urgency-filter').addEventListener('change', filterTable);
    document.getElementById('type-filter').addEventListener('change', filterTable);
    document.getElementById('distance-filter').addEventListener('change', filterTable);

    function filterTable() {
        const urgency = document.getElementById('urgency-filter').value;
        const type = document.getElementById('type-filter').value;
        const distance = document.getElementById('distance-filter').value;
        const rows = document.querySelectorAll('.data-table tbody tr');

        rows.forEach(row => {
            let show = true;

            if (urgency && !row.textContent.includes(urgency.charAt(0).toUpperCase() + urgency.slice(1))) {
                show = false;
            }

            if (type && !row.querySelector(`.incident-type.${type}`)) {
                show = false;
            }

            if (distance) {
                const distanceText = row.cells[3].textContent;
                const distanceValue = parseFloat(distanceText);
                if (distanceValue > parseFloat(distance)) {
                    show = false;
                }
            }

            row.style.display = show ? '' : 'none';
        });
    }
</script>
<style>
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}