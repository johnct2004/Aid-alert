{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}System Reports - Admin Dashboard{% endblock %}
{% block page_title %}System Reports{% endblock %}

{% block admin_css %}
<link rel="stylesheet" href="{% static 'css/admin/system_reports.css' %}">
{% endblock %}

{% block admin_content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons-round">people</span>
        </div>
        <div class="stat-content">
            <h3 class="stat-title">Total Users</h3>
            <p class="stat-value">{{ total_users }}</p>
            <span class="stat-info">{% if user_growth > 0 %}+{% endif %}{{ user_growth }}% Growth</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons-round">warning</span>
        </div>
        <div class="stat-content">
            <h3 class="stat-title">Total Incidents</h3>
            <p class="stat-value">{{ total_incidents }}</p>
            <span class="stat-info">Reported all time</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons-round">local_shipping</span>
        </div>
        <div class="stat-content">
            <h3 class="stat-title">Active Responders</h3>
            <p class="stat-value">{{ active_responders }}</p>
            <span class="stat-info">Currently online</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons-round">storefront</span>
        </div>
        <div class="stat-content">
            <h3 class="stat-title">Marketplace Items</h3>
            <p class="stat-value">{{ marketplace_items }}</p>
            <span class="stat-info">Active listings</span>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 24px;">
    <!-- Activity Trend Chart -->
    <div class="glass-card" style="min-height: 400px; padding: 24px;">
        <h2 class="card-title" style="margin-bottom: 20px;">System Activity Trends (Last 7 Days)</h2>
        <div style="position: relative; height: 320px; width:100%;">
            <canvas id="activityChart"></canvas>
        </div>
    </div>

    <!-- Incident Status Chart -->
    <div class="glass-card" style="min-height: 400px; padding: 24px;">
        <h2 class="card-title" style="margin-bottom: 20px;">Incident Resolution</h2>
        <div style="position: relative; height: 250px; width:100%; display:flex; justify-content:center;">
            <canvas id="statusChart"></canvas>
        </div>
        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 20px;">
            <div style="text-align: center;">
                <h3 style="margin: 0; font-size: 1.5rem; color: var(--primary-color);">{{ incident_open }}</h3>
                <span style="font-size: 0.85rem; color: #666;">Open</span>
            </div>
            <div style="text-align: center;">
                <h3 style="margin: 0; font-size: 1.5rem; color: #10b981;">{{ incident_resolved }}</h3>
                <span style="font-size: 0.85rem; color: #666;">Resolved</span>
            </div>
        </div>
    </div>
</div>
<!-- Reports Table Section -->
<div class="glass-card">
    <div class="card-header-row">
        <h2 class="card-title">Recent Reports</h2>
        <div class="filters-wrapper">
            <button class="btn-primary btn-sm" onclick="openGenerateModal()">
                <span class="material-icons-round" style="font-size: 18px;">add_chart</span>
                Generate New Report
            </button>
            <div class="search-box">
                <span class="material-icons-round search-icon">search</span>
                <input type="text" class="search-input" placeholder="Search Reports">
            </div>
            <div class="dropdowns">
                <select class="filter-select">
                    <option>Report Type</option>
                    <option>User Activity</option>
                    <option>Incident Summary</option>
                    <option>System Performance</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Report ID</th>
                    <th>Type</th>
                    <th>Title</th>
                    <th>Generated</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr>
                    <td>{{ report.report_id }}</td>
                    <td>
                        {% if report.report_type == 'user_activity' %}
                        <span class="report-type type-user">User Activity</span>
                        {% elif report.report_type == 'incident_summary' %}
                        <span class="report-type type-incident">Incident Summary</span>
                        {% elif report.report_type == 'system_performance' %}
                        <span class="report-type type-performance">System Performance</span>
                        {% elif report.report_type == 'marketplace_stats' %}
                        <span class="report-type type-marketplace">Marketplace Stats</span>
                        {% else %}
                        <span class="report-type">{{ report.get_report_type_display }}</span>
                        {% endif %}
                    </td>
                    <td>{{ report.title }}</td>
                    <td>{{ report.generated_at|date:"Y-m-d h:i A" }}</td>
                    <td>
                        <select class="status-select status-{{ report.status }}" onchange="updateReportStatus(this)">
                            <option value="completed" {% if report.status == "completed" %} selected {% endif %}>Completed</option>
                            <option value="processing" {% if report.status == "processing" %} selected {% endif %}>Processing</option>
                            <option value="scheduled" {% if report.status == "scheduled" %} selected {% endif %}>Scheduled</option>
                            <option value="failed" {% if report.status == "failed" %} selected {% endif %}>Failed</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn-action" data-id="{{ report.report_id }}"
                            data-type="{{ report.get_report_type_display }}" data-title="{{ report.title }}"
                            data-date="{{ report.generated_at|date:'Y-m-d h:i A' }}" data-status="{{ report.status }}"
                            onclick="viewReport(this)">View</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 30px; color: #888;">No reports found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block admin_js %}
<!-- Screen Reader / No-JS fallback -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    window.systemReportData = {
        chartDates: JSON.parse('{{ chart_dates|safe }}'),
        incidentTrend: JSON.parse('{{ incident_trend|safe }}'),
        userTrend: JSON.parse('{{ user_trend|safe }}'),
        orderTrend: JSON.parse('{{ order_trend|safe }}'),
        incidentOpen: parseInt('{{ incident_open }}'),
        incidentResolved: parseInt('{{ incident_resolved }}')
    };
</script>
<script src="{% static 'js/admin/system_reports.js' %}"></script>

<!-- Report Details Modal -->
<div id="reportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Report Details</h3>
        </div>

        <div class="info-row">
            <div class="metric-item" style="padding: 15px; border-radius: 10px;">
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Report ID</p>
                <h4 id="modalReportId" style="margin: 0; color: var(--primary-color);"></h4>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
            <div class="metric-item" style="padding: 15px; border-radius: 10px;">
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Type</p>
                <p id="modalReportType" style="margin: 0; font-weight: 600;"></p>
            </div>
            <div class="metric-item" style="padding: 15px; border-radius: 10px;">
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Status</p>
                <p id="modalReportStatus" style="margin: 0; font-weight: 600;"></p>
            </div>
        </div>

        <div class="info-row">
            <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Title</p>
            <p id="modalReportTitle" style="margin: 0; font-weight: 500; font-size: 1.1rem;"></p>
        </div>

        <div class="info-row" style="border: none;">
            <p style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Generated On</p>
            <p id="modalReportDate" style="margin: 0;"></p>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn-primary" onclick="downloadReport()">
                <span class="material-icons-round" style="font-size: 18px;">download</span>
                Download
            </button>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div id="generateReportModal" class="modal"
    style="display:none; align-items:center; justify-content:center; position:fixed; top:0; left:0; width:100%; height:100vh; background:rgba(0,0,0,0.5); z-index:2000;">
    <div
        style="background:white; padding:30px; border-radius:15px; width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
        <h2 style="margin-top:0; margin-bottom:20px;">Generate New Report</h2>

        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#555;">Report Type</label>
            <select id="newReportType" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                <option value="system_performance">System Performance</option>
                <option value="user_activity">User Activity</option>
                <option value="incident_summary">Incident Summary</option>
                <option value="marketplace_stats">Marketplace Stats</option>
            </select>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="closeGenerateModal()"
                style="padding:10px 20px; border:none; background:none; cursor:pointer; color:#666;">Cancel</button>
            <button id="generateBtn" onclick="handleGenerateReport()"
                style="padding:10px 20px; border:none; background:var(--primary-color); color:white; border-radius:8px; cursor:pointer; font-weight:600;">Generate</button>
        </div>
    </div>
</div>
{% endblock %}