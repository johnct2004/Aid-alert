{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}Admin Profile - Aid Alert{% endblock %}
{% block page_title %}Admin Profile{% endblock %}

{% block admin_css %}
<link rel="stylesheet" href="{% static 'css/admin/admin_profile.css' %}">
{% endblock %}

{% block admin_content %}
<!-- Profile Overview -->
<div class="glass-card profile-section-card">
    <div class="card-header-row">
        <h2 class="card-title">Profile Overview</h2>
        <div class="profile-actions admin-actions">
            <button class="btn-secondary edit-admin-btn" onclick="toggleAdminEdit(this)">
                <span class="material-icons-round">edit</span> Edit Profile
            </button>
            <button class="btn-primary save-admin-btn hidden" onclick="saveAdminInfo(this)">
                <span class="material-icons-round">save</span> Save Changes
            </button>
            <button class="btn-secondary cancel-admin-btn hidden" onclick="cancelAdminEdit(this)">
                <span class="material-icons-round">close</span> Cancel
            </button>
        </div>
    </div>

    <div class="profile-overview">
        <div class="profile-avatar">
            <div class="avatar-large">
                <span class="material-icons-round">admin_panel_settings</span>
            </div>
        </div>

        <div class="profile-info">
            <div class="info-grid">
                <div class="info-item">
                    <h3 class="info-label">Admin Name</h3>
                    <p class="info-value" id="overview-name">{{ user.get_full_name|default:user.username }}</p>
                    <input type="text" class="info-input hidden" id="overview-name-input"
                        value="{{ user.get_full_name|default:user.username }}">
                </div>
                <div class="info-item">
                    <h3 class="info-label">Email</h3>
                    <p class="info-value" id="overview-email">{{ user.email }}</p>
                    <input type="email" class="info-input hidden" id="overview-email-input" value="{{ user.email }}">
                </div>
                <div class="info-item">
                    <h3 class="info-label">Role</h3>
                    <p class="info-value" id="overview-role">System Administrator</p>
                    <input type="text" class="info-input hidden" id="overview-role-input" value="System Administrator">
                </div>
                <div class="info-item">
                    <h3 class="info-label">Department</h3>
                    <p class="info-value" id="overview-department">System Administration</p>
                    <select class="info-input hidden" id="overview-department-input">
                        <option value="System Administration" selected>System Administration</option>
                        <option value="IT Support">IT Support</option>
                        <option value="Security">Security</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Administrative Information -->
<div class="glass-card profile-section-card">
    <div class="card-header-row">
        <h2 class="card-title">Administrative Information</h2>
        <!-- Added Buttons to this section as well -->
        <div class="profile-actions admin-actions">
            <button class="btn-secondary edit-admin-btn" onclick="toggleAdminEdit(this)">
                <span class="material-icons-round">edit</span> Edit
            </button>
            <button class="btn-primary save-admin-btn hidden" onclick="saveAdminInfo(this)">
                <span class="material-icons-round">save</span> Save
            </button>
            <button class="btn-secondary cancel-admin-btn hidden" onclick="cancelAdminEdit(this)">
                <span class="material-icons-round">close</span> Cancel
            </button>
        </div>
    </div>

    <div class="admin-info admin-info-layout">
        <div class="info-section">
            <h3 class="section-title">Personal Details</h3>
            <div class="info-grid single-column">
                <div class="info-item">
                    <h4 class="info-label">Full Name</h4>
                    <p class="info-value" id="full-name">{{ user.get_full_name|default:user.username }}</p>
                    <input type="text" class="info-input hidden" id="full-name-input"
                        value="{{ user.get_full_name|default:user.username }}">
                </div>
                <div class="info-item">
                    <h4 class="info-label">Official Email</h4>
                    <p class="info-value" id="official-email">{{ user.email }}</p>
                    <input type="email" class="info-input hidden" id="official-email-input" value="{{ user.email }}">
                </div>
                <div class="info-item">
                    <h4 class="info-label">Phone Extension</h4>
                    <p class="info-value" id="phone-ext">{{ user.profile.phone|default:"Not Provided" }}</p>
                    <input type="text" class="info-input hidden" id="phone-ext-input"
                        value="{{ user.profile.phone|default:'' }}">
                </div>
            </div>
        </div>

        <div class="info-section">
            <h3 class="section-title">Department Information</h3>
            <div class="info-grid single-column">
                <div class="info-item">
                    <h4 class="info-label">Department</h4>
                    <p class="info-value" id="department">System Administration</p>
                    <select class="info-input hidden" id="department-input">
                        <option value="System Administration" selected>System Administration</option>
                        <option value="IT Support">IT Support</option>
                    </select>
                </div>
                <div class="info-item">
                    <h4 class="info-label">Office Location</h4>
                    <p class="info-value" id="office-location">{{ user.profile.address|default:"Main Office" }}</p>
                    <input type="text" class="info-input hidden" id="office-location-input"
                        value="{{ user.profile.address|default:'Main Office' }}">
                </div>
                <div class="info-item">
                    <h4 class="info-label">Time Zone</h4>
                    <p class="info-value" id="timezone">UTC</p>
                    <select class="info-input hidden" id="timezone-input">
                        <option value="UTC" selected>UTC</option>
                        <option value="EST">EST</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Access & Actions Grid -->
<div class="admin-info-layout">
    <!-- System Access Control -->
    <div class="glass-card profile-action-card">
        <div class="card-header-row">
            <h2 class="card-title">System Access Control</h2>
        </div>
        <div class="settings-list">
            <div class="setting-item">
                <div class="setting-info">
                    <h4 class="setting-title">Two-Factor Authentication</h4>
                    <p class="setting-description">Enhanced security for admin account</p>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" id="adminTwoFactor" class="toggle-input" checked>
                    <label for="adminTwoFactor" class="toggle-label"></label>
                </div>
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <h4 class="setting-title">Session Timeout</h4>
                    <p class="setting-description">Auto-logout after inactivity</p>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" id="sessionTimeout" class="toggle-input" checked>
                    <label for="sessionTimeout" class="toggle-label"></label>
                </div>
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <h4 class="setting-title">Login Alerts</h4>
                    <p class="setting-description">Security notifications for admin access</p>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" id="adminLoginAlerts" class="toggle-input" checked>
                    <label for="adminLoginAlerts" class="toggle-label"></label>
                </div>
            </div>
        </div>
    </div>

    <!-- Administrative Actions -->
    <div class="glass-card profile-action-card">
        <div class="card-header-row">
            <h2 class="card-title">Quick Actions</h2>
        </div>
        <div class="account-actions-grid">
            <a href="{% url 'aid_app:manage_users' %}" class="action-btn">
                <span class="material-icons-round">people</span>
                <span>Users</span>
            </a>
            <a href="{% url 'aid_app:system_reports' %}" class="action-btn">
                <span class="material-icons-round">assessment</span>
                <span>Reports</span>
            </a>
            <a href="{% url 'aid_app:view_all_incidents' %}" class="action-btn">
                <span class="material-icons-round">emergency</span>
                <span>Incidents</span>
            </a>
            <a href="{% url 'aid_app:marketplace_monitor' %}" class="action-btn">
                <span class="material-icons-round">shop</span>
                <span>Market</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_js %}
<script>
    // Scoped functions to handle section-specific editing
    function toggleAdminEdit(btn) {
        const container = btn.closest('.glass-card');
        if (!container) return;

        container.querySelectorAll('.info-value').forEach(el => el.classList.add('hidden'));
        container.querySelectorAll('.info-input').forEach(el => el.classList.remove('hidden'));

        // Toggle buttons within this container
        container.querySelectorAll('.edit-admin-btn').forEach(b => b.classList.add('hidden'));
        container.querySelectorAll('.save-admin-btn').forEach(b => b.classList.remove('hidden'));
        container.querySelectorAll('.cancel-admin-btn').forEach(b => b.classList.remove('hidden'));
    }

    function cancelAdminEdit(btn) {
        const container = btn.closest('.glass-card');
        if (!container) return;

        container.querySelectorAll('.info-input').forEach(el => el.classList.add('hidden'));
        container.querySelectorAll('.info-value').forEach(el => el.classList.remove('hidden'));

        // Toggle buttons within this container
        container.querySelectorAll('.edit-admin-btn').forEach(b => b.classList.remove('hidden'));
        container.querySelectorAll('.save-admin-btn').forEach(b => b.classList.add('hidden'));
        container.querySelectorAll('.cancel-admin-btn').forEach(b => b.classList.add('hidden'));
    }

    function saveAdminInfo(btn) {
        const container = btn.closest('.glass-card');
        if (!container) return;

        // Map of text ID -> Input ID for possible fields
        const fieldMap = {
            'overview-name': 'overview-name-input',
            'overview-email': 'overview-email-input',
            'overview-role': 'overview-role-input',
            'overview-department': 'overview-department-input',
            'full-name': 'full-name-input',
            'official-email': 'official-email-input',
            'phone-ext': 'phone-ext-input',
            'department': 'department-input',
            'office-location': 'office-location-input',
            'timezone': 'timezone-input'
        };

        // Update values only for fields present in this container
        for (const [textId, inputId] of Object.entries(fieldMap)) {
            const textEl = container.querySelector('#' + textId);
            const inputEl = container.querySelector('#' + inputId);
            if (textEl && inputEl) {
                textEl.textContent = inputEl.value;
            }
        }

        cancelAdminEdit(btn);
        showNotification('Changes saved successfully!');
    }

    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification-toast';
        notification.innerHTML = `<span class="material-icons-round">check_circle</span> ${message}`;
        document.body.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 3000);
    }
</script>
{% endblock %}