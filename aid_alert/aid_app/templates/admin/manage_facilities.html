{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}Manage Facilities - Admin Dashboard{% endblock %}
{% block page_title %}Manage Facilities{% endblock %}

{% block admin_css %}
<link rel="stylesheet" href="{% static 'css/admin/manage_facilities.css' %}">
{% endblock %}

{% block admin_content %}
<div class="glass-card">
    <div class="card-header-row">
        <h2 class="card-title">All Facilities</h2>
    </div>

    <div class="filters-wrapper">
        <div class="search-box">
            <span class="material-icons-round search-icon" style="color: #999;">search</span>
            <input type="text" class="search-input" placeholder="Search Facilities">
        </div>
        <div class="dropdowns">
            <select class="filter-select">
                <option>Type</option>
                <option>Medical</option>
                <option>Shelter</option>
                <option>Logistics</option>
            </select>
            <select class="filter-select">
                <option>Status</option>
                <option>Active</option>
                <option>Inactive</option>
                <option>Full</option>
            </select>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Facility ID</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Location</th>
                    <th>Capacity</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for facility in facilities %}
                <tr>
                    <td>FAC-{{ facility.id|stringformat:"03d" }}</td>
                    <td style="font-weight: 500;">
                        {% if facility.real_facility %}
                        {{ facility.real_facility.facility_name }}
                        {% else %}
                        {{ facility.user.get_full_name|default:facility.user.username }}
                        {% endif %}
                    </td>
                    <td>{{ facility.role|title }}</td>
                    <td>
                        {% if facility.real_facility %}
                        {{ facility.real_facility.address }}
                        {% else %}
                        {{ facility.address }}
                        {% endif %}
                    </td>
                    <td>
                        {% if facility.real_facility %}
                        {{ facility.real_facility.capacity }}
                        {% else %}
                        â€”
                        {% endif %}
                    </td>
                    <td>
                        {% if facility.real_facility %}
                        <span class="badge badge-{{ facility.real_facility.status }}">
                            {{ facility.real_facility.get_status_display }}
                        </span>
                        {% else %}
                        {% if facility.user.is_active %}
                        <span class="badge badge-active">Active</span>
                        {% else %}
                        <span class="badge badge-inactive">Inactive</span>
                        {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <!-- View Button (using new openViewModal) -->
                            <button class="btn-icon view-btn" onclick="openViewModal(this)"
                                data-id="FAC-{{ facility.id|stringformat:'03d' }}"
                                data-name="{% if facility.real_facility %}{{ facility.real_facility.facility_name }}{% else %}{{ facility.user.get_full_name|default:facility.user.username }}{% endif %}"
                                data-type="Facility"
                                data-address="{% if facility.real_facility %}{{ facility.real_facility.address }}{% else %}{{ facility.address }}{% endif %}"
                                data-status="{% if facility.real_facility %}{{ facility.real_facility.get_status_display }}{% else %}{% if facility.user.is_active %}Active{% else %}Inactive{% endif %}{% endif %}"
                                style="background:none; border:none; color:var(--primary-color); cursor:pointer;">
                                <span class="material-icons-round">visibility</span>
                            </button>

                            <!-- Edit Button -->
                            <button class="btn-icon edit-btn" onclick="openEditModal(this)"
                                data-profile-id="{{ facility.id }}" data-id="FAC-{{ facility.id|stringformat:'03d' }}"
                                data-name="{% if facility.real_facility %}{{ facility.real_facility.facility_name }}{% else %}{{ facility.user.get_full_name|default:facility.user.username }}{% endif %}"
                                data-address="{% if facility.real_facility %}{{ facility.real_facility.address }}{% else %}{{ facility.address }}{% endif %}"
                                data-capacity="{% if facility.real_facility %}{{ facility.real_facility.capacity }}{% else %}0{% endif %}"
                                data-status="{% if facility.real_facility %}{{ facility.real_facility.status }}{% else %}{% if facility.user.is_active %}active{% else %}inactive{% endif %}{% endif %}"
                                style="background:none; border:none; color:var(--warning-color); cursor:pointer;">
                                <span class="material-icons-round">edit</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 30px; color: #888;">No facilities found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block admin_js %}
<script>
    // View Facility functionality
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const row = this.closest('tr');
            const cells = row.getElementsByTagName('td');
            const facilityId = cells[0].textContent;
            const facilityName = cells[1].textContent;
            const facilityType = cells[2].textContent;
            const facilityRole = cells[3].textContent; // Actually Location header in table is index 3, Capacity is 4. Re-checking usage.
            // Wait, in table: ID=0, Name=1, Type=2, Location=3, Capacity=4, Status=5

            // Re-reading row content mapping:
            // 0: ID, 1: Name, 2: Type, 3: Location (Addr), 4: Cap, 5: Status

            const facilityAddress = cells[3].textContent;
            const facilityStatus = row.querySelector('.badge').textContent;

            // Create facility details modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Facility Details</h2>
                        <button class="modal-close" onclick="closeViewModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="facility-detail-card">
                            <div class="detail-header" style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                                <div class="detail-avatar" style="width:50px; height:50px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                    <span class="material-icons-round" style="font-size:30px; color:#555;">apartment</span>
                                </div>
                                <div class="detail-info">
                                    <h3 style="margin:0;">${facilityName}</h3>
                                    <p style="margin:0; color:#666;">ID: ${facilityId}</p>
                                    <div class="detail-badges" style="margin-top:5px;">
                                        <span class="badge">${facilityStatus}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="detail-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                                <div class="detail-item">
                                    <label style="font-weight:600; font-size:0.9rem;">Facility Type</label>
                                    <p style="margin:5px 0;">${facilityType}</p>
                                </div>
                                <div class="detail-item">
                                    <label style="font-weight:600; font-size:0.9rem;">Address</label>
                                    <p style="margin:5px 0;">${facilityAddress}</p>
                                </div>
                                <div class="detail-item">
                                    <label style="font-weight:600; font-size:0.9rem;">Status</label>
                                    <p style="margin:5px 0;">${facilityStatus}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" style="padding:8px 15px; border:1px solid #ddd; background:white; border-radius:6px; cursor:pointer;" onclick="closeViewModal()">Close</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        });
    });

    // Edit Facility functionality
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const row = this.closest('tr');
            const cells = row.getElementsByTagName('td');
            const facilityId = cells[0].textContent;
            const facilityName = cells[1].textContent;
            const facilityType = cells[2].textContent;
            const facilityAddress = cells[3].textContent;
            const statusElement = row.querySelector('.badge');
            let currentStatus = 'active';
            if (statusElement.classList.contains('badge-inactive')) currentStatus = 'inactive';

            // Create edit facility modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Edit Facility</h2>
                        <button class="modal-close" onclick="closeEditModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="editFacilityForm">
                            <div class="form-group">
                                <label for="editId">Facility ID</label>
                                <input type="text" id="editId" name="id" value="${facilityId}" readonly style="background:#f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label for="editName">Facility Name</label>
                                <input type="text" id="editName" name="name" value="${facilityName}" required>
                            </div>
                            <div class="form-group">
                                <label for="editType">Facility Type</label>
                                <select id="editType" name="type" required>
                                    <option value="Hospital" ${facilityType === 'Hospital' ? 'selected' : ''}>Hospital</option>
                                    <option value="Fire Station" ${facilityType === 'Fire Station' ? 'selected' : ''}>Fire Station</option>
                                    <option value="Police Station" ${facilityType === 'Police Station' ? 'selected' : ''}>Police Station</option>
                                    <option value="Emergency Center" ${facilityType === 'Emergency Center' ? 'selected' : ''}>Emergency Center</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editAddress">Address</label>
                                <textarea id="editAddress" name="address" rows="3" required>${facilityAddress}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="editStatus">Status</label>
                                <select id="editStatus" name="status" required>
                                    <option value="active" ${currentStatus === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${currentStatus === 'inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" style="padding:8px 15px; border:1px solid #ddd; background:white; border-radius:6px; cursor:pointer;" onclick="closeEditModal()">Cancel</button>
                        <button class="btn btn-primary" style="padding:8px 15px; border:none; background:var(--primary-color); color:white; border-radius:6px; cursor:pointer;" onclick="submitEditFacility()">Save Changes</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        });
    });

    // Modal functions
    window.closeViewModal = function () {
        const modal = document.querySelector('.modal');
        if (modal) {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
        }
    };

    window.closeEditModal = function () {
        const modal = document.querySelector('.modal');
        if (modal) {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
        }
    };

    window.submitEditFacility = function () {
        // Simulate submission
        showNotification(`Facility updated successfully!`, 'success');
        closeEditModal();
        setTimeout(() => { location.reload(); }, 1500);
    };

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; bottom: 20px; right: 20px;
            background: ${type === 'success' ? '#2ecc71' : '#e74c3c'};
            color: white; padding: 12px 24px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;
            display: flex; align-items: center; gap: 10px; font-weight: 500;
        `;
        notification.innerHTML = `<span class="material-icons-round">check_circle</span><span>${message}</span>`;
        document.body.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 3000);
    }
</script>
{% endblock %}