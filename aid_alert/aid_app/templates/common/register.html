{% extends 'common/base.html' %}
{% load static %}

{% block title %}Register - Aid Alert{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/register.css' %}">
{% endblock %}

{% block content %}
<div class="register-container">
    <div class="glass-card register-card">
        <a href="{% url 'aid_app:home' %}" class="logo-text">AID ALERT</a>
        <h2 class="register-title">Create Account</h2>

        <!-- Display Django messages -->
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}

        <form action="{% url 'aid_app:register' %}" method="POST">
            {% csrf_token %}

            <div class="form-grid">
                <div class="input-group">
                    <label for="first_name">First Name</label>
                    <input type="text" id="first_name" name="first_name" class="glass-input" required>
                </div>

                <div class="input-group">
                    <label for="last_name">Last Name</label>
                    <input type="text" id="last_name" name="last_name" class="glass-input" required>
                </div>

                <div class="input-group full-width">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" class="glass-input" required>
                </div>

                <div class="input-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" class="glass-input" placeholder="10-digit number"
                        maxlength="10" pattern="[0-9]{10}" required>
                    <small class="form-hint">Enter exactly 10 digits</small>
                </div>

                <div class="input-group">
                    <label for="gender">Gender</label>
                    <select id="gender" name="gender" class="glass-input">
                        <option value="" disabled selected>Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="input-group full-width">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" class="glass-input" required>
                </div>

                <div class="input-group full-width">
                    <label for="user_role">I am a...</label>
                    <select id="user_role" name="user_role" class="glass-input" required onchange="toggleRoleFields()">
                        <option value="" disabled selected>Select Your Role</option>
                        <option value="user">User (Seeker)</option>
                        <option value="seller">Seller (Marketplace)</option>
                        <option value="facility">Medical Facility</option>
                        <option value="responder">First Responder</option>
                    </select>
                </div>

                <!-- Seller Specific Fields -->
                <div id="seller_fields" class="role-specific-field" style="display: none; width: 100%;">
                    <div class="form-grid">
                        <div class="input-group">
                            <label for="shop_name">Shop Name</label>
                            <input type="text" id="shop_name" name="shop_name" class="glass-input">
                        </div>
                        <div class="input-group">
                            <label for="license_no">License Number</label>
                            <input type="text" id="license_no" name="license_no" class="glass-input">
                        </div>
                    </div>
                </div>

                <!-- Facility Specific Fields -->
                <div id="facility_fields" class="role-specific-field" style="display: none; width: 100%;">
                    <div class="form-grid">
                        <div class="input-group">
                            <label for="facility_name">Facility Name</label>
                            <input type="text" id="facility_name" name="facility_name" class="glass-input">
                        </div>
                        <div class="input-group">
                            <label for="capacity">Capacity (Beds/Patients)</label>
                            <input type="number" id="capacity" name="capacity" class="glass-input" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-group full-width">
                    <label for="address">Address (Optional)</label>
                    <input type="text" id="address" name="address" class="glass-input">
                </div>

                <div class="input-group full-width">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" class="glass-input" required>
                    <div class="password-requirements">
                        <p class="requirements-title">Password must contain:</p>
                        <ul class="requirements-list">
                            <li>At least 8 characters</li>
                            <li>At least one uppercase letter</li>
                            <li>At least one lowercase letter</li>
                            <li>At least one number</li>
                        </ul>
                    </div>
                </div>

                <div class="input-group full-width">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" name="confirm_password" class="glass-input" required>
                </div>
            </div>

            <button type="submit" class="register-btn">Create Account</button>

            <div class="form-footer">
                <p>Already have an account? <a href="{% url 'aid_app:login' %}" class="sign-in">Sign in</a></p>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Enhanced phone number validation
    const phoneInput = document.getElementById('phone');

    if (phoneInput) {
        phoneInput.addEventListener('input', function (e) {
            const value = e.target.value;
            e.target.value = value.replace(/\D/g, ''); // Only numbers

            if (e.target.value.length === 10) {
                e.target.setCustomValidity('');
                e.target.style.borderColor = '#2ecc71'; // Green
            } else if (e.target.value.length > 0) {
                e.target.setCustomValidity('Please enter exactly 10 digits');
                e.target.style.borderColor = '#e74c3c'; // Red
            } else {
                e.target.setCustomValidity('');
                e.target.style.borderColor = 'rgba(255, 255, 255, 0.4)'; // Default glass border
            }
        });
    }

    // Password requirements validation
    const passwordInput = document.getElementById('password');
    const requirementsList = document.querySelector('.requirements-list');

    if (passwordInput && requirementsList) {
        const requirements = [
            { regex: /.{8,}/, text: 'At least 8 characters' },
            { regex: /[A-Z]/, text: 'At least one uppercase letter' },
            { regex: /[a-z]/, text: 'At least one lowercase letter' },
            { regex: /[0-9]/, text: 'At least one number' }
        ];

        passwordInput.addEventListener('input', function () {
            const password = this.value;
            const listItems = requirementsList.querySelectorAll('li');

            requirements.forEach((req, index) => {
                const listItem = listItems[index];
                if (req.regex.test(password)) {
                    listItem.style.color = '#2ecc71'; // Green
                    listItem.style.textDecoration = 'line-through';
                } else {
                    listItem.style.color = '#666'; // Default
                    listItem.style.textDecoration = 'none';
                }
            });
        });
    }
    function toggleRoleFields() {
        const role = document.getElementById('user_role').value;
        const sellerFields = document.getElementById('seller_fields');
        const facilityFields = document.getElementById('facility_fields');
        const shopName = document.getElementById('shop_name');
        const licenseNo = document.getElementById('license_no');
        const facilityName = document.getElementById('facility_name');
        const capacity = document.getElementById('capacity');

        // Reset all first
        sellerFields.style.display = 'none';
        facilityFields.style.display = 'none';

        // Remove required attributes to avoid validation errors on hidden fields
        shopName.required = false;
        licenseNo.required = false;
        facilityName.required = false;
        capacity.required = false;

        if (role === 'seller') {
            sellerFields.style.display = 'block';
            shopName.required = true;
            licenseNo.required = true;
        } else if (role === 'facility') {
            facilityFields.style.display = 'block';
            facilityName.required = true;
            capacity.required = true; // Optional based on preference, but good for data
        }
    }
</script>
{% endblock %}